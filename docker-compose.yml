
services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: ev
      POSTGRES_PASSWORD: evpass
      POSTGRES_DB: evdb
    volumes:
      - dbdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ev -d evdb -h 127.0.0.1"]
      interval: 5s
      timeout: 3s
      retries: 20

  auth_service:
    build: ./auth-service
    environment:
      DATABASE_URL: postgresql+psycopg2://ev:evpass@db:5432/evdb
      JWT_SECRET: supersecret
      PORT: 5001
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "5001:5001"
    healthcheck:
      test:
        - CMD-SHELL
        - |
          python - <<'PY'
          import sys, urllib.request
          try:
              r = urllib.request.urlopen('http://localhost:5001/auth/', timeout=3)
              sys.exit(0 if r.status == 200 else 1)
          except Exception:
              sys.exit(1)
          PY
      interval: 10s
      timeout: 3s
      retries: 20
    # (khuyến nghị) seed admin ở lần chạy đầu:
    # command: sh -lc "python init_db.py && python app.py"

  admin_service:
    build: ./admin-service
    environment:
      DATABASE_URL: postgresql+psycopg2://ev:evpass@db:5432/evdb
      JWT_SECRET: supersecret
      AUTH_URL: http://auth_service:5001   # QUAN TRỌNG: gọi qua DNS nội bộ
      PORT: 5002
    depends_on:
      db:
        condition: service_healthy
      auth_service:
        condition: service_healthy
    ports:
      - "5002:5002"
    healthcheck:
      test:
        - CMD-SHELL
        - |
          python - <<'PY'
          import sys, urllib.request
          try:
              r = urllib.request.urlopen('http://localhost:5002/health', timeout=3)
              sys.exit(0 if r.status == 200 else 1)
          except Exception:
              sys.exit(1)
          PY
      interval: 10s
      timeout: 3s
      retries: 20

  payment_service:
    build: ./payment-service
    environment:
      DATABASE_URL: postgresql+psycopg2://ev:evpass@db:5432/evdb
      PORT: 5003
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "5003:5003"
    healthcheck:
      test:
        - CMD-SHELL
        - |
          python - <<'PY'
          import sys, urllib.request
          try:
              r = urllib.request.urlopen('http://localhost:5003/health', timeout=3)
              sys.exit(0 if r.status == 200 else 1)
          except Exception:
              sys.exit(1)
          PY
      interval: 10s
      timeout: 3s
      retries: 20

  web_gateway:
    build: ./gateway
    environment:
      AUTH_URL:     http://auth_service:5001
      ADMIN_URL:    http://admin_service:5002
      PAYMENT_URL:  http://payment_service:5003
      JWT_SECRET:   supersecret
      GATEWAY_SECRET: dev
      PORT: 8000
    depends_on:
      auth_service:
        condition: service_healthy
      admin_service:
        condition: service_healthy
      payment_service:
        condition: service_healthy
    ports:
      - "8000:8000"
    volumes:
      - ./gateway:/app

volumes:
  dbdata:
