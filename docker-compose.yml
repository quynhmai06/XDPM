services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: ev
      POSTGRES_PASSWORD: evpass
      POSTGRES_DB: evdb
    volumes: [dbdata:/var/lib/postgresql/data]
    ports: ["5432:5432"]

  auth_service:
    build: ./auth-service
    environment:
      DATABASE_URL: postgresql+psycopg2://ev:evpass@db:5432/evdb
      JWT_SECRET: supersecret
    depends_on: [db]
    ports: ["5001:5001"]

  listing_service:
    build: ./listing-service
    environment:
      DATABASE_URL: postgresql+psycopg2://ev:evpass@db:5432/evdb
      JWT_SECRET: supersecret
    depends_on: [db]
    ports: ["5002:5002"]
    
  pricing_service:
    build: ./pricing-service
    environment:
      PROVIDER: ${PROVIDER}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      GEMINI_MODEL: ${GEMINI_MODEL}
      # Dự phòng OpenAI (không dùng khi PROVIDER=gemini)
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL}
    ports: ["5003:5003"]


  web_gateway:
    build: ./gateway
    environment:
      AUTH_URL: http://auth_service:5001
      LISTING_URL: http://listing_service:5002
      PRICING_URL: http://pricing_service:5003
      JWT_SECRET: supersecret         
      GATEWAY_SECRET: dev
    depends_on: [auth_service, listing_service, pricing_service]
    ports: ["8000:8000"]

volumes:
  dbdata:
