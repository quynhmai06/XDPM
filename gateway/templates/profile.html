<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hồ sơ cá nhân</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --border:#e5e7eb; --primary:#111827;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .container{max-width:900px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    header .subtitle{color:var(--muted);margin-top:4px}
    .btn{height:36px;padding:0 14px;border-radius:10px;border:1px solid var(--primary);background:var(--primary);color:#fff;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--primary);border-color:var(--border)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .grid{display:grid;grid-template-columns:220px 1fr;gap:16px;align-items:start}
    .avatar-wrap{position:relative;display:block;width:180px}
    .avatar{width:180px;height:180px;border-radius:14px;object-fit:cover;border:1px solid var(--border);background:#f9fafb}
    .avatar-edit{position:absolute;bottom:8px;left:8px;right:8px;text-align:center;font-size:13px;background:rgba(0,0,0,.65);color:#fff;padding:6px 8px;border-radius:10px}
    .hidden{display:none}
    .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    label{font-size:13px;color:#475467;display:block;margin-bottom:6px}
    input[type="text"],input[type="email"],input[type="tel"],input[type="date"],select{
      height:38px;padding:0 10px;border-radius:10px;border:1px solid var(--border);background:#fff;outline:none;width:100%;
    }
    .form-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    @media (max-width:820px){
      .grid{grid-template-columns:1fr}
      .avatar-wrap,.avatar{width:140px;height:140px}
      .form-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Hồ sơ cá nhân</h1>
        <p class="subtitle">Xem và chỉnh sửa thông tin của bạn</p>
      </div>
      <div>
        <button class="btn ghost" id="btnRefresh">Làm mới</button>
      </div>
    </header>

    <section class="card">
      <div class="grid">
        <div>
          <label class="avatar-wrap" for="avatarInput">
            <img id="avatarImg" alt="Avatar" class="avatar" />
            <input id="avatarInput" type="file" accept="image/*" class="hidden" />
            <span class="avatar-edit">Đổi ảnh</span>
          </label>
        </div>
        <form id="profileForm">
          <div class="form-grid">
            <div>
              <label>Họ tên</label>
              <input id="full_name" type="text" placeholder="Nguyễn Văn A" required>
            </div>
            <div>
              <label>Email (chỉ hiển thị)</label>
              <input id="email" type="email" disabled>
            </div>
            <div>
              <label>Số điện thoại</label>
              <input id="phone" type="tel" placeholder="0xxxxxxxxx">
            </div>
            <div>
              <label>Địa chỉ</label>
              <input id="address" type="text" placeholder="Số nhà, đường, quận/huyện, tỉnh/thành">
            </div>
            <div>
              <label>Ngày sinh</label>
              <input id="birthdate" type="date">
            </div>
            <div>
              <label>Giới tính</label>
              <select id="gender">
                <option value="">— Chọn —</option>
                <option value="male">Nam</option>
                <option value="female">Nữ</option>
                <option value="other">Khác</option>
              </select>
            </div>
          </div>
          <div class="form-actions">
            <button class="btn" type="submit" id="btnSave">Lưu thay đổi</button>
            <button class="btn ghost" type="button" id="btnReset">Hoàn tác</button>
          </div>
          <p class="muted" id="status" style="margin-top:8px"></p>
        </form>
      </div>
    </section>
  </div>

  <script>
    // ======== AUTH-SERVICE ENDPOINTS ========
    const API = {
      me: 'http://127.0.0.1:5001/auth/me',
      profile: 'http://127.0.0.1:5001/auth/profile'
    };


    // ======== HELPERS ========
    const $ = (s)=>document.querySelector(s);
    const statusEl = $('#status');
    const avatarImg = $('#avatarImg');
    const fallbackAvatar = 'data:image/svg+xml;utf8,'+encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="180" height="180">
        <rect width="100%" height="100%" fill="#f3f4f6"/>
        <circle cx="90" cy="70" r="40" fill="#d1d5db"/>
        <rect x="30" y="120" width="120" height="50" rx="12" fill="#d1d5db"/>
      </svg>`);

    function getToken(){
      return localStorage.getItem('ACCESS_TOKEN') || '{{ session.get("access_token", "") }}';
    }
    function setAvatar(src){ avatarImg.src = src || fallbackAvatar; }
    function setStatus(msg, ok=true){
      statusEl.textContent = msg || '';
      statusEl.style.color = ok ? '#059669' : '#b91c1c';
    }

    async function fetchWithAuth(url, init={}){
      const headers = new Headers(init.headers || {});
      const token = getToken();
      if (token) headers.set('Authorization', 'Bearer ' + token);
      const res = await fetch(url, { ...init, headers });
      if (res.status === 401) {
        localStorage.removeItem('ACCESS_TOKEN');
        window.location.href = '/login.html';
      }
      return res;
    }
    async function apiGet(url, params){
      const q = params ? '?' + new URLSearchParams(params) : '';
      const res = await fetchWithAuth(url+q);
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function apiPut(url, body){
      const res = await fetchWithAuth(url, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    async function apiUpload(url, formData){
      const res = await fetchWithAuth(url, { method:'POST', body: formData });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    // ======== STATE & RENDER ========
    let data = { user:{}, profile:{} };

    function render(){
      const p = data.profile || {};
      const u = data.user || {};
      $('#full_name').value = p.full_name || '';
      $('#email').value = u.email || '';
      $('#phone').value = (u.phone || '').toString();
      $('#address').value = p.address || '';
      $('#birthdate').value = (p.birthdate || '').slice(0,10);
      $('#gender').value = p.gender || '';

      let raw = p.avatar_url || '';
      if (!raw) setAvatar(fallbackAvatar);
      else if (raw.startsWith('http') || raw.startsWith('/')) setAvatar(raw);
      else setAvatar(`/static/uploads/avatars/${raw}`);
    }

    async function loadProfile(){
      setStatus('Đang tải hồ sơ...', true);
      try{
        data = await apiGet(API.profile); // { user, profile }
        render();
        setStatus('');
      }catch(e){
        setStatus('Không tải được hồ sơ: ' + e, false);
      }
    }

    // ======== EVENTS ========
    $('#btnRefresh').addEventListener('click', loadProfile);

    $('#btnReset').addEventListener('click', ()=> render());

    $('#avatarInput').addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0];
      if(!f) return;
      const rd = new FileReader();
      rd.onload = ()=> setAvatar(rd.result);
      rd.readAsDataURL(f);
    });

    $('#profileForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      setStatus('Đang lưu...', true);
      try{
        // 1) Upload avatar nếu có
        const file = $('#avatarInput').files[0];
        if (file) {
          const fd = new FormData();
          fd.append('avatar', file);
          // Optionally kèm text để backend cập nhật form (nếu muốn)
          fd.append('full_name', $('#full_name').value.trim());
          fd.append('address', $('#address').value.trim());
          fd.append('gender', $('#gender').value);
          fd.append('birthdate', $('#birthdate').value || '');
          fd.append('phone', $('#phone').value.trim());
          const up = await apiUpload(API.profile, fd);
          if (up && up.avatar_src) setAvatar(up.avatar_src);
          // đồng bộ state nếu backend trả profile/user
          if (up && up.profile) data.profile = up.profile;
          if (up && up.user) data.user = up.user;
        }

        // 2) Cập nhật thông tin JSON
        const payload = {
          full_name: $('#full_name').value.trim(),
          address: $('#address').value.trim(),
          gender: $('#gender').value,
          birthdate: $('#birthdate').value || '',
          phone: $('#phone').value.trim()
        };
        const updated = await apiPut(API.profile, payload);
        if (updated && updated.profile) data.profile = updated.profile;
        if (updated && updated.user) data.user = updated.user;

        render();
        setStatus('Đã lưu hồ sơ!', true);
      }catch(err){
        setStatus('Không thể lưu: ' + err, false);
      }
    });

    /// ======== INIT ========
    (async function init(){
      const token = getToken();
      if (!token){
        window.location.href = '/login';
        return;
      }

      setAvatar(fallbackAvatar);

      try {
        await apiGet(API.me);   // <- không truyền token
      } catch {
        window.location.href = '/login';
        return;
      }

      await loadProfile();      // <- không truyền token
    })();

  </script>
</body>
</html>
