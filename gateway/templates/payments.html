<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Giao dịch & Thanh toán</title>
  <!-- Minimal CSS: grid + card + input -->
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; --acc:#22c55e; --warn:#f59e0b; --err:#ef4444; --bd:#1f2937; }
    *{box-sizing:border-box} body{margin:0;background:#0b1220;color:var(--txt);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:8px 0 20px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:18px}
    .card h2{margin:4px 0 14px;font-size:20px}
    .row{display:grid;grid-template-columns:170px 1fr;gap:10px;align-items:center;margin:8px 0}
    label{color:var(--muted);font-size:14px}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--bd);background:#0b1220;color:var(--txt);
    }
    textarea{min-height:120px;resize:vertical}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--bd);padding:10px 14px;border-radius:10px;background:#162034;color:#e5e7eb;cursor:pointer}
    .btn.primary{background:#1e293b;border-color:#2a364c}
    .btn.success{background:#14532d;border-color:#166534}
    .btn.warn{background:#3b2a12;border-color:#5a3c16}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--bd);display:inline-block}
    .badge.ok{background:#052e1a;border-color:#0a4f2c}
    .badge.fail{background:#3a1212;border-color:#5b1a1a}
    .hr{height:1px;background:var(--bd);margin:14px 0}
    .row-inline{display:flex;gap:10px}
    .toast{position:fixed;right:18px;bottom:18px;min-width:260px;max-width:420px;background:#0b1220;border:1px solid var(--bd);border-radius:12px;padding:12px 14px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none}
    .toast.show{display:block}
    .toast.ok{border-color:#166534}
    .toast.err{border-color:#7f1d1d}
    code{background:#0b1220;border:1px solid var(--bd);padding:4px 8px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Giao dịch & Thanh toán <span class="badge ok">Demo e-wallet / banking & hợp đồng số</span></h1>

    <div class="grid">
      <!-- LEFT: CREATE PAYMENT -->
      <div class="card">
        <h2>Tạo thanh toán</h2>
        <div class="row"><label>Order ID</label><input id="orderId" type="number" placeholder="VD: 1001" value="1001"></div>
        <div class="row"><label>Số tiền (VND)</label><input id="amount" type="text" placeholder="VD: 15000000" value="15000000"></div>
        <div class="row"><label>Buyer ID</label><input id="buyerId" type="number" placeholder="VD: 501" value="501"></div>
        <div class="row"><label>Seller ID</label><input id="sellerId" type="number" placeholder="VD: 302" value="302"></div>
        <div class="row">
          <label>Phương thức</label>
          <select id="method">
            <option value="e-wallet" selected>E-Wallet</option>
            <option value="banking">Banking</option>
          </select>
        </div>
        <div class="row"><label>Provider</label><input id="provider" type="text" value="DemoPay"></div>

        <div class="row-inline" style="margin-top:10px">
          <button class="btn primary" id="btnCreate">Tạo thanh toán</button>
          <div class="muted" id="createStatus"></div>
        </div>

        <div class="hr"></div>

        <div class="row"><label>Giả lập thanh toán</label><input id="simPid" type="number" placeholder="payment_id"></div>
        <div class="row-inline">
          <button class="btn success" id="btnSim">Giả lập thanh toán (Paid)</button>
          <div class="muted">Dùng khi chưa tích hợp MoMo/VNPay</div>
        </div>
      </div>

      <!-- RIGHT: CONTRACT -->
      <div class="card">
        <h2>Hợp đồng mua bán số hóa</h2>
        <div class="row"><label>Payment ID</label><input id="cPaymentId" type="number" placeholder="ID từ bước tạo thanh toán"></div>
        <div class="row"><label>Tiêu đề</label><input id="cTitle" type="text" value="Hợp đồng mua bán xe điện"></div>
        <div class="row"><label>Nội dung</label>
          <textarea id="cContent">Bên A (Người bán) cam kết tình trạng pin theo mô tả; Bên B (Người mua) thanh toán đủ số tiền...</textarea>
        </div>
        <div class="row-inline">
          <button class="btn primary" id="btnCreateContract">Tạo hợp đồng</button>
          <div class="muted" id="contractStatus"></div>
        </div>

        <div class="hr"></div>

        <div class="row"><label>Contract ID</label><input id="signCid" type="number" placeholder="ID hợp đồng vừa tạo"></div>
        <div class="row"><label>Người ký</label><input id="signer" type="text" placeholder="Nguyễn Văn B"></div>

        <div class="row-inline">
          <button class="btn warn" id="btnSign">Ký điện tử</button>
          <div class="muted" id="signStatus"></div>
        </div>

        <div class="hr"></div>
        <div class="muted">Trạng thái: <span id="badgeStatus" class="badge">chưa có</span></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><div id="toastText"></div></div>

  <script>
    const BASE = "{{ base_url }}"; // từ Flask, ví dụ http://localhost:8000

    // Helpers
    const $ = (id) => document.getElementById(id);
    const toast = (msg, ok=true) => {
      const t = $("toast"), txt = $("toastText");
      txt.textContent = msg; t.className = "toast show " + (ok?"ok":"err");
      setTimeout(()=> t.className="toast", 2200);
    };

    // Format tiền: hiển thị có dấu phẩy, gửi số nguyên
    const formatMoney = (v) => {
      let n = v.replace(/[^\d]/g,"");
      return n.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    };
    const parseMoney = (v) => parseInt(v.replace(/[^\d]/g,"")||"0",10);

    $("amount").addEventListener("input", e => e.target.value = formatMoney(e.target.value));

    // Badge trạng thái
    const setBadge = (txt, ok=true) => {
      const b = $("badgeStatus");
      b.textContent = txt;
      b.className = "badge " + (ok?"ok":"fail");
    };

    // 1) Tạo thanh toán
    $("btnCreate").onclick = async () => {
      const order_id = parseInt($("orderId").value || "0",10);
      const buyer_id = parseInt($("buyerId").value || "0",10);
      const seller_id = parseInt($("sellerId").value || "0",10);
      const amount = parseMoney($("amount").value);
      const method = $("method").value;
      const provider = $("provider").value || "DemoPay";

      if (!order_id || !buyer_id || !seller_id || !amount) {
        toast("Vui lòng nhập đủ Order/Buyer/Seller/Amount", false);
        return;
      }
      $("btnCreate").disabled = true;
      $("createStatus").textContent = "Đang tạo...";

      try {
        const r = await fetch(`${BASE}/api/payments/create`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({order_id, buyer_id, seller_id, amount, method, provider})
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || "create_failed");

        $("simPid").value = data.payment_id;
        $("cPaymentId").value = data.payment_id;
        setBadge(`pending (payment_id=${data.payment_id})`, false);
        $("createStatus").innerHTML = `Đã tạo: <code>#${data.payment_id}</code>`;
        toast("Tạo thanh toán thành công");
      } catch (e) {
        toast("Lỗi tạo thanh toán: " + e.message, false);
        $("createStatus").textContent = "Lỗi";
      } finally {
        $("btnCreate").disabled = false;
      }
    };

    // 2) Giả lập thanh toán (paid)
    $("btnSim").onclick = async () => {
      const pid = parseInt($("simPid").value||"0",10);
      if (!pid) return toast("Nhập Payment ID để giả lập", false);

      $("btnSim").disabled = true;
      try {
        const r = await fetch(`${BASE}/api/payments/${pid}/confirm`, {method:"POST"});
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || "simulate_failed");
        setBadge(`paid (#${pid})`, true);
        toast("Đã chuyển trạng thái Paid");
      } catch(e) {
        toast("Lỗi simulate: " + e.message, false);
      } finally {
        $("btnSim").disabled = false;
      }
    };

    // 3) Tạo hợp đồng
    $("btnCreateContract").onclick = async () => {
      const payment_id = parseInt($("cPaymentId").value||"0",10);
      const title = $("cTitle").value.trim();
      const content = $("cContent").value.trim();
      if(!payment_id) return toast("Thiếu Payment ID", false);

      $("btnCreateContract").disabled = true;
      $("contractStatus").textContent = "Đang tạo...";

      try {
        const r = await fetch(`${BASE}/api/contracts/create`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({payment_id, title, content})
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || "create_contract_failed");
        $("signCid").value = data.contract_id;
        $("contractStatus").innerHTML = `Đã tạo: <code>#${data.contract_id}</code>`;
        toast("Tạo hợp đồng thành công");
      } catch(e) {
        toast("Lỗi tạo hợp đồng: " + e.message, false);
        $("contractStatus").textContent = "Lỗi";
      } finally { $("btnCreateContract").disabled = false; }
    };

    // 4) Ký hợp đồng
    $("btnSign").onclick = async () => {
      const contract_id = parseInt($("signCid").value||"0",10);
      const signer_name = $("signer").value.trim();
      if(!contract_id || !signer_name) return toast("Thiếu Contract ID/Người ký", false);

      $("btnSign").disabled = true;
      $("signStatus").textContent = "Đang ký...";

      try {
        const r = await fetch(`${BASE}/api/contracts/sign`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({contract_id, signer_name})
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || "sign_failed");
        $("signStatus").innerHTML = `Đã ký ✔`;
        toast("Ký điện tử thành công");
      } catch(e) {
        toast("Lỗi ký hợp đồng: " + e.message, false);
        $("signStatus").textContent = "Lỗi";
      } finally { $("btnSign").disabled = false; }
    };
  </script>
</body>
</html>
