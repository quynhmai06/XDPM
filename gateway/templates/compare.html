<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>So sánh sản phẩm - EV Trading</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .compare-header {
        background: #f5f5f5;
        padding: 30px 20px;
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        border-bottom: 2px solid #e0e0e0;
      }

      .compare-header h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 500;
        color: #555;
      }

      .compare-count {
        margin-top: 8px;
        font-size: 14px;
        color: #888;
      }

      .compare-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .compare-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }

      .btn-clear-all {
        padding: 10px 20px;
        background: #ff4757;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      .btn-clear-all:hover {
        background: #ff3838;
        transform: translateY(-2px);
      }

      .btn-back {
        padding: 10px 20px;
        background: #666;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s;
      }

      .btn-back:hover {
        background: #555;
        transform: translateY(-2px);
      }

      .compare-table-wrapper {
        overflow-x: auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .compare-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
      }

      .compare-table th,
      .compare-table td {
        padding: 15px;
        text-align: center;
        border: 1px solid #e0e0e0;
      }

      .compare-table th {
        background: #f8f8f8;
        font-weight: 600;
        color: #333;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .compare-table tr:nth-child(even) {
        background: #fafafa;
      }

      .compare-table .row-label {
        text-align: left;
        font-weight: 600;
        color: #555;
        background: #f0f0f0;
        position: sticky;
        left: 0;
        z-index: 5;
      }

      .compare-img {
        width: 100%;
        max-width: 200px;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        margin: 10px auto;
        display: block;
      }

      .compare-product-name {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin: 10px 0;
      }

      .compare-price {
        font-size: 18px;
        font-weight: 700;
        color: #ff6f00;
        margin: 10px 0;
      }

      .remove-item-btn {
        padding: 6px 12px;
        background: #ff4757;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-top: 10px;
        transition: all 0.2s;
      }

      .remove-item-btn:hover {
        background: #ff3838;
      }

      .compare-value {
        font-size: 14px;
        color: #333;
      }

      .compare-value i {
        margin-right: 5px;
        color: #ff6f00;
      }

      .empty-compare {
        text-align: center;
        padding: 80px 20px;
        color: #999;
      }

      .empty-compare i {
        font-size: 80px;
        margin-bottom: 20px;
        opacity: 0.3;
      }

      .empty-compare h3 {
        font-size: 24px;
        color: #666;
        margin-bottom: 10px;
      }

      .empty-compare p {
        color: #999;
        margin-bottom: 30px;
      }

      .btn-browse {
        display: inline-block;
        padding: 12px 32px;
        background: linear-gradient(135deg, #ff6f00 0%, #ffa726 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(255, 111, 0, 0.2);
      }

      .btn-browse:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 111, 0, 0.3);
      }

      .highlight-best {
        background: #fff9e6 !important;
        font-weight: 600;
      }

      @media (max-width: 768px) {
        .compare-table th,
        .compare-table td {
          padding: 10px;
          font-size: 12px;
        }
        .compare-img {
          max-width: 120px;
          height: 90px;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <div class="logo-section">
          <button class="menu-toggle"><i class="fas fa-bars"></i></button>
          <img src="/static/images/logo.png" alt="EV Trading" class="logo" />
        </div>
        {% set actual_user = session.get('user') %}
        <div class="user-menu">
          <a href="/favorites" class="user-menu-item">Yêu thích</a>
          <a href="/cart" class="user-menu-item">Giỏ hàng</a>
          <a href="/admin" class="user-menu-item">Admin</a>
          {% if actual_user %}
          <a href="{{ url_for('logout_page') }}" class="user-menu-item"
            >Đăng xuất</a
          >
          {% else %}
          <a href="{{ url_for('login_page') }}" class="user-menu-item"
            >Đăng nhập</a
          >
          {% endif %}
        </div>
      </div>
    </header>

    <div class="compare-header">
      <h2><i class="fas fa-balance-scale"></i> So sánh sản phẩm</h2>
      <p class="compare-count" id="compareCount">0 sản phẩm đang so sánh</p>
    </div>

    <div class="compare-container">
      <div class="compare-actions">
        <a href="/" class="btn-back">
          <i class="fas fa-arrow-left"></i> Quay lại
        </a>
        <button class="btn-clear-all" onclick="clearAll()">
          <i class="fas fa-trash"></i> Xóa tất cả
        </button>
      </div>

      <div id="compareContent">
        <div class="empty-compare">
          <i class="fas fa-balance-scale"></i>
          <h3>Chưa có sản phẩm để so sánh</h3>
          <p>Hãy thêm sản phẩm từ trang chủ để so sánh chi tiết</p>
          <a href="/" class="btn-browse">Khám phá ngay</a>
        </div>
      </div>
    </div>

    <script>
      // Items passed from server
      const serverItems = {{ items | tojson | safe }};

      const fmtMoney = (v) => (Number(v) || 0).toLocaleString("vi-VN") + " đ";

      // Load compare items from localStorage (support both keys)
      function getCompareItems() {
        const listStr = localStorage.getItem("compareList");
        if (listStr) {
          try {
            return JSON.parse(listStr) || [];
          } catch {}
        }
        const legacy = localStorage.getItem("compareItems");
        if (legacy) {
          try {
            return JSON.parse(legacy) || [];
          } catch {}
        }
        return [];
      }

      function setCompareItems(items) {
        const s = JSON.stringify(items || []);
        localStorage.setItem("compareList", s);
        localStorage.setItem("compareItems", s);
      }

      function removeItem(type, id) {
        let items = getCompareItems();
        items = items.filter(
          (item) =>
            !(
              String(item.type) === String(type) &&
              Number(item.id) === Number(id)
            )
        );
        setCompareItems(items);
        loadCompareData();
      }

      function clearAll() {
        if (
          confirm(
            "Bạn có chắc muốn xóa tất cả sản phẩm khỏi danh sách so sánh?"
          )
        ) {
          localStorage.removeItem("compareItems");
          localStorage.removeItem("compareList");
          loadCompareData();
        }
      }

      async function loadCompareData() {
        // Use server items if available (from URL params)
        if (serverItems && serverItems.length > 0) {
          const countEl = document.getElementById("compareCount");
          countEl.textContent = `${serverItems.length} sản phẩm đang so sánh`;

          // Normalize items
          const validItems = serverItems.map(item => ({
            ...item,
            _type: (item.item_type || item.product_type || 'vehicle').toString().toLowerCase()
          }));

          renderCompareTable(validItems);
          return;
        }

        // Fallback to localStorage
        const items = getCompareItems();
        const countEl = document.getElementById("compareCount");
        countEl.textContent = `${items.length} sản phẩm đang so sánh`;

        if (items.length === 0) {
          document.getElementById("compareContent").innerHTML = `
            <div class="empty-compare">
              <i class="fas fa-balance-scale"></i>
              <h3>Chưa có sản phẩm để so sánh</h3>
              <p>Hãy thêm sản phẩm từ trang chủ để so sánh chi tiết</p>
              <a href="/" class="btn-browse">Khám phá ngay</a>
            </div>
          `;
          return;
        }

        // Fetch data for all items from localStorage
        const promises = items.map(async (item) => {
          try {
            const id = item.id || item;
            // Prefer JSON API first for robustness
            let res = await fetch(`/api/listings/${id}`);
            if (!res.ok) {
              // Fallback to HTML endpoint (expect JSON only in newer versions)
              res = await fetch(`/listings/${id}`);
            }
            if (res.ok) {
              const data = await res.json();
              const normType = (data.product_type || data.item_type || item.type || "")
                .toString()
                .toLowerCase();
              return { ...data, _type: normType };
            }
          } catch (e) {
            console.error("Error fetching item:", e);
          }
          return null;
        });

        const results = await Promise.all(promises);
        const validItems = results.filter((r) => r !== null);

        if (validItems.length === 0) {
          document.getElementById("compareContent").innerHTML = `
            <div class="empty-compare">
              <i class="fas fa-exclamation-circle"></i>
              <h3>Không tìm thấy sản phẩm</h3>
              <p>Các sản phẩm có thể đã bị xóa hoặc không khả dụng</p>
              <a href="/" class="btn-browse">Khám phá ngay</a>
            </div>
          `;
          return;
        }

        renderCompareTable(validItems);
      }

      function renderCompareTable(items) {
        const col = (getter) =>
          items
            .map((item) => `<td class="compare-value">${getter(item)}</td>`)
            .join("");

        const safe = (v, fallback = "N/A") =>
          v === null || v === undefined || v === "" ? fallback : v;

        const yesno = (b) => (b ? "Đã duyệt" : "Chờ duyệt");

        const rows = [];

        // Images
        rows.push(`
          <tr>
            <td class="row-label">Hình ảnh</td>
            ${items
              .map(
                (item) => `
                  <td>
                    <img
                      src="${safe(
                        item.main_image_url,
                        "/static/images/logo.png"
                      )}"
                      alt="${safe(item.name, "Product")}"
                      class="compare-img"
                      onerror="this.onerror=null;this.src='/static/images/logo.png'"
                    />
                  </td>`
              )
              .join("")}
          </tr>
        `);

        // Name + remove action
        rows.push(`
          <tr>
            <td class="row-label">Tên sản phẩm</td>
            ${items
              .map(
                (item) => `
                  <td>
                    <div class="compare-product-name">${safe(
                      item.name,
                      "Không rõ"
                    )}</div>
                    <button class="remove-item-btn" onclick="removeItem('${(
                      item._type ||
                      item.product_type ||
                      ""
                    )
                      .toString()
                      .toLowerCase()}', ${item.id})">
                      <i class="fas fa-times"></i> Xóa
                    </button>
                  </td>`
              )
              .join("")}
          </tr>
        `);

        // Product type
        rows.push(`
          <tr>
            <td class="row-label">Loại sản phẩm</td>
            ${col((it) =>
              safe((it.product_type || it._type || "").toString().toUpperCase())
            )}
          </tr>
        `);

        // Brand
        rows.push(`
          <tr>
            <td class="row-label">Thương hiệu</td>
            ${col((it) => safe(it.brand || ""))}
          </tr>
        `);

        // Giá
        rows.push(`
          <tr>
            <td class="row-label">Giá</td>
            ${col((it) => fmtMoney(it.price))}
          </tr>
        `);

        // Year
        rows.push(`
          <tr>
            <td class="row-label">Năm sản xuất</td>
            ${col((it) => safe(it.year || "N/A"))}
          </tr>
        `);

        // Province
        rows.push(`
          <tr>
            <td class="row-label">Tỉnh/Thành</td>
            ${col((it) => safe(it.province || "N/A"))}
          </tr>
        `);

        // Mileage
        rows.push(`
          <tr>
            <td class="row-label">Quãng đường đã đi (km)</td>
            ${col((it) => (Number(it.mileage) || 0).toLocaleString("vi-VN"))}
          </tr>
        `);

        // Battery capacity
        rows.push(`
          <tr>
            <td class="row-label">Dung lượng pin</td>
            ${col((it) => safe(it.battery_capacity || "N/A"))}
          </tr>
        `);

        // Battery chemistry
        rows.push(`
          <tr>
            <td class="row-label">Hóa học pin</td>
            ${col((it) => safe(it.battery_chemistry || "N/A"))}
          </tr>
        `);

        // SOH
        rows.push(`
          <tr>
            <td class="row-label">SOH (%)</td>
            ${col((it) => safe(it.soh_percent ?? "N/A"))}
          </tr>
        `);

        // Cycle count
        rows.push(`
          <tr>
            <td class="row-label">Chu kỳ sạc</td>
            ${col((it) => safe(it.cycle_count ?? "N/A"))}
          </tr>
        `);

        // Owner
        rows.push(`
          <tr>
            <td class="row-label">Chủ sở hữu</td>
            ${col((it) => safe(it.owner || "N/A"))}
          </tr>
        `);

        // Approved
        rows.push(`
          <tr>
            <td class="row-label">Trạng thái duyệt</td>
            ${col((it) => yesno(!!it.approved))}
          </tr>
        `);

        // Created date
        rows.push(`
          <tr>
            <td class="row-label">Ngày đăng</td>
            ${col((it) => safe((it.created_at || "").slice(0, 10) || "—", "—"))}
          </tr>
        `);

        // Description
        rows.push(`
          <tr>
            <td class="row-label">Mô tả</td>
            ${items
              .map(
                (it) => `
                  <td class="compare-value" style="text-align: left; padding: 15px;">
                    ${safe(it.description || "Không có mô tả")}
                  </td>`
              )
              .join("")}
          </tr>
        `);

        const html = `
          <div class="compare-table-wrapper">
            <table class="compare-table">
              <thead>
                <tr>
                  <th class="row-label">Thông số</th>
                  ${items
                    .map((item) => `<th>${safe(item.brand || "")}</th>`)
                    .join("")}
                </tr>
              </thead>
              <tbody>
                ${rows.join("\n")}
              </tbody>
            </table>
          </div>
        `;

        document.getElementById("compareContent").innerHTML = html;
      }

      // Load data on page load
      loadCompareData();
    </script>
  </body>
</html>
