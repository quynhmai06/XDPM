<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ÄÄƒng bÃ¡n xe/pin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    :root{
      --brand:#f5a300; /* vÃ ng chá»§ Ä‘áº¡o */
      --ink:#0f172a;   /* Ä‘en xanh */
      --muted:#64748b; --line:#e5e7eb; --ok:#16a34a; --err:#dc2626;
      --card:#ffffff; --bg:#fafafa;
      --radius:14px;
    }
    body{background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:980px;margin:28px auto; padding:0 16px}
    .hero{
      background:linear-gradient(180deg,#ffe08a, #ffd166);
      border:1px solid #fcd34d; border-radius:var(--radius);
      padding:18px 20px; margin-bottom:18px;
      display:flex; align-items:center; gap:12px
    }
    .hero b{font-size:18px}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:0 8px 24px rgba(0,0,0,.04);
      padding:18px;
    }
    h1{font-size:22px; margin:0 0 6px}
    .hint{color:var(--muted); font-size:14px; margin-bottom:16px}

    /* form */
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width: 780px){ .grid{grid-template-columns:1fr} }
    label{font-weight:600; margin:8px 0 6px; display:block}
    .req::after{content:" *"; color:var(--err)}
    input[type=text], input[type=number], select, textarea{
      width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:10px; background:#fff;
      outline:none; transition:all .15s ease
    }
    textarea{min-height:120px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.15)}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width: 780px){ .row{grid-template-columns:1fr} }

    .file-row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width: 780px){ .file-row{grid-template-columns:1fr} }

    .actions{display:flex; gap:12px; align-items:center; justify-content:flex-end; margin-top:14px}
    .btn{appearance:none; border:1px solid #0f172a; background:#0f172a; color:#fff; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:600}
    .btn:disabled{opacity:.7; cursor:not-allowed}
    .btn-outline{background:#fff; color:#0f172a}
    .btn-brand{background:var(--brand); border-color:#c97f00}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; font-size:13px; background:#fff7ed; border:1px solid #fed7aa}

    /* AI block */
    .ai-bar{display:flex; gap:10px; align-items:center}
    .ai-msg{font-size:14px}
    .ai-msg.ok{color:var(--ok)} .ai-msg.err{color:var(--err)} .ai-msg.muted{color:var(--muted)}
    .price-row{display:flex; gap:10px; align-items:center}
    .price-row input[type=number]{flex:1}
    .chip{padding:4px 8px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe; font-size:12px; color:#3730a3}
    .flash{padding:12px; border-radius:10px; margin-bottom:12px}
    .flash.success{background:#ecfdf5; border:1px solid #bbf7d0; color:#166534}
    .flash.error{background:#fef2f2; border:1px solid #fecaca; color:#991b1b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="pill"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 4v16m8-8H4" stroke="#c97f00" stroke-width="2" stroke-linecap="round"/></svg>ÄÄƒng tin nhanh</div>
      <b>ÄÄƒng bÃ¡n xe/pin Ä‘Ã£ qua sá»­ dá»¥ng</b>
      <span class="hint">Nháº­p thÃ´ng tin tháº­t chÃ­nh xÃ¡c Ä‘á»ƒ AI gá»£i Ã½ giÃ¡ há»£p lÃ½.</span>
    </div>

    <!-- flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="flash {{ cat }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="card">
      <h1>ThÃ´ng tin sáº£n pháº©m</h1>
      <p class="hint">CÃ¡c má»¥c cÃ³ dáº¥u <span style="color:#dc2626">*</span> lÃ  báº¯t buá»™c.</p>

      <form action="{{ url_for('add_listing') }}" method="POST" enctype="multipart/form-data" id="postForm" novalidate>
        <!-- Loáº¡i + TÃªn -->
        <div class="grid">
          <div>
            <label class="req" for="product_type">Loáº¡i sáº£n pháº©m</label>
            <select id="product_type" name="product_type">
              <option value="car" {% if request.form.get('product_type','car')=='car' %}selected{% endif %}>Xe Ä‘iá»‡n</option>
              <option value="battery" {% if request.form.get('product_type')=='battery' %}selected{% endif %}>Pin xe Ä‘iá»‡n</option>
            </select>
          </div>
          <div>
            <label class="req" for="name">TÃªn sáº£n pháº©m</label>
            <input id="name" type="text" name="name" required value="{{ request.form.get('name','') }}" placeholder="VD: VinFast VF e34 2023, pin 42 kWh">
          </div>
        </div>

        <!-- MÃ´ táº£ -->
        <label for="description">MÃ´ táº£ chi tiáº¿t (tÃ¬nh tráº¡ng, sá»­a chá»¯a, phá»¥ kiá»‡nâ€¦)</label>
        <textarea id="description" name="description" placeholder="Ghi rÃµ tÃ¬nh tráº¡ng xe/pin, lá»‹ch sá»­ báº£o dÆ°á»¡ngâ€¦">{{ request.form.get('description','') }}</textarea>

        <!-- HÃ£ng / Tá»‰nh -->
        <div class="grid">
          <div>
            <label for="brand">HÃ£ng</label>
            <input id="brand" type="text" name="brand" value="{{ request.form.get('brand','') }}" placeholder="VinFast, Tesla, MGâ€¦">
          </div>
          <div>
            <label class="req" for="province">Tá»‰nh/ThÃ nh phá»‘</label>
            <select id="province" name="province" required>
              {% set pv = request.form.get('province','') %}
              <option value="">--Chá»n tá»‰nh/thÃ nh phá»‘--</option>
              {% for p in [
                'HÃ  Ná»™i','Há»“ ChÃ­ Minh','An Giang','BÃ  Rá»‹a - VÅ©ng TÃ u','Báº¯c Giang','Báº¯c Káº¡n','Báº¡c LiÃªu','Báº¯c Ninh',
                'Báº¿n Tre','BÃ¬nh Äá»‹nh','BÃ¬nh DÆ°Æ¡ng','BÃ¬nh PhÆ°á»›c','BÃ¬nh Thuáº­n','CÃ  Mau','Cao Báº±ng','ÄÃ  Náºµng',
                'Äáº¯k Láº¯k','Äáº¯k NÃ´ng','Äiá»‡n BiÃªn','Äá»“ng Nai','Äá»“ng ThÃ¡p','Gia Lai','HÃ  Giang','HÃ  Nam','HÃ  TÄ©nh',
                'Háº£i DÆ°Æ¡ng','Háº£i PhÃ²ng','Háº­u Giang','HÃ²a BÃ¬nh','HÆ°ng YÃªn','KhÃ¡nh HÃ²a','KiÃªn Giang','Kon Tum',
                'Lai ChÃ¢u','LÃ¢m Äá»“ng','Láº¡ng SÆ¡n','LÃ o Cai','Long An','Nam Äá»‹nh','Nghá»‡ An','Ninh BÃ¬nh','Ninh Thuáº­n',
                'PhÃº Thá»','Quáº£ng BÃ¬nh','Quáº£ng Nam','Quáº£ng NgÃ£i','Quáº£ng Ninh','Quáº£ng Trá»‹','SÃ³c TrÄƒng','SÆ¡n La',
                'TÃ¢y Ninh','ThÃ¡i BÃ¬nh','ThÃ¡i NguyÃªn','Thanh HÃ³a','Thá»«a ThiÃªn Huáº¿','Tiá»n Giang','TrÃ  Vinh',
                'TuyÃªn Quang','VÄ©nh Long','VÄ©nh PhÃºc','YÃªn BÃ¡i'
              ] %}
                <option value="{{ p }}" {% if pv==p %}selected{% endif %}>{{ p }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- NÄƒm / ODO -->
        <div class="grid">
          <div>
            <label for="year">NÄƒm sáº£n xuáº¥t</label>
            <input id="year" type="number" name="year" min="2008" max="2100" value="{{ request.form.get('year','') }}" placeholder="VD: 2023">
          </div>
          <div>
            <label for="mileage">Sá»‘ km Ä‘Ã£ Ä‘i</label>
            <input id="mileage" type="number" name="mileage" min="0" step="1" value="{{ request.form.get('mileage','') }}" placeholder="VD: 20000">
          </div>
        </div>

        <!-- Dung lÆ°á»£ng pin -->
        <div>
          <label for="battery_capacity">Dung lÆ°á»£ng pin</label>
          <input id="battery_capacity" type="text" name="battery_capacity" value="{{ request.form.get('battery_capacity','') }}" placeholder="VD: 42 kWh">
          <p class="hint" id="typeHint"><span class="chip">Gá»£i Ã½</span> Vá»›i â€œPin xe Ä‘iá»‡nâ€, hÃ£y ghi Ä‘Ãºng dung lÆ°á»£ng (kWh) Ä‘á»ƒ AI Ä‘á»‹nh giÃ¡ chuáº©n hÆ¡n.</p>
        </div>

        <!-- áº¢nh -->
        <div class="file-row">
          <div>
            <label class="req" for="main_image">áº¢nh chÃ­nh sáº£n pháº©m</label>
            <input id="main_image" type="file" name="main_image" accept=".jpg,.jpeg,.png,.webp,image/*" {% if not request.form %}required{% endif %}>
          </div>
          <div>
            <label for="sub_images">áº¢nh Ä‘i kÃ¨m</label>
            <input id="sub_images" type="file" name="sub_images" accept=".jpg,.jpeg,.png,.webp,image/*" multiple>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--line); margin:18px 0">

        <!-- GIÃ + AI  -->
        <div>
          <label class="req" for="price">GiÃ¡ mong muá»‘n (VNÄ)</label>
          <div class="ai-bar">
            <div class="price-row" style="flex:1">
              <input id="price" type="number" name="price" min="1" step="1" required
                     value="{{ request.form.get('price','') }}" placeholder="Nháº­p tay hoáº·c báº¥m Gá»£i Ã½ AI">
            </div>
            <button type="button" class="btn btn-brand" id="aiSuggestBtn">Gá»£i Ã½ giÃ¡ AI</button>
          </div>
          <div id="aiResult" class="ai-msg muted" style="margin-top:8px;"></div>
        </div>

        <div class="actions">
          <a class="btn btn-outline" href="{{ url_for('home') }}">Huá»·</a>
          <button type="submit" class="btn">ÄÄƒng bÃ¡n</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ThÃ´ng bÃ¡o loáº¡i sáº£n pháº©m Ä‘á»ƒ ngÆ°á»i bÃ¡n Ä‘iá»n Ä‘Ãºng
    const typeSel = document.getElementById('product_type');
    const typeHint = document.getElementById('typeHint');
    function refreshHint(){
      if(!typeSel || !typeHint) return;
      typeHint.innerHTML = (typeSel.value === 'battery')
        ? '<span class="chip">Gá»£i Ã½</span> Báº¡n Ä‘ang Ä‘Äƒng <b>Pin xe Ä‘iá»‡n</b> â€” hÃ£y ghi Ä‘Ãºng dung lÆ°á»£ng (kWh), mÃ´ táº£ tÃ¬nh tráº¡ng vÃ  sá»‘ láº§n sáº¡c náº¿u biáº¿t.'
        : '<span class="chip">Gá»£i Ã½</span> Báº¡n Ä‘ang Ä‘Äƒng <b>Xe Ä‘iá»‡n</b> â€” nháº­p ODO, nÄƒm SX, dung lÆ°á»£ng pin Ä‘á»ƒ AI Ä‘á»‹nh giÃ¡ chÃ­nh xÃ¡c.';
    }
    if(typeSel){ typeSel.addEventListener('change', refreshHint); refreshHint(); }

    // Kiá»ƒm tra dung lÆ°á»£ng file cÆ¡ báº£n
    function bindSizeCheck(inputEl){
      if(!inputEl) return;
      inputEl.addEventListener('change', () => {
        for(const f of inputEl.files){
          if(f.size > 10 * 1024 * 1024){
            alert('áº¢nh quÃ¡ 10MB: ' + f.name);
            inputEl.value = '';
            break;
          }
        }
      });
    }
    bindSizeCheck(document.getElementById('main_image'));
    bindSizeCheck(document.getElementById('sub_images'));

   // === Gá»£i Ã½ giÃ¡ AI (gá»­i JSON á»•n Ä‘á»‹nh) ===

async function callAISuggest(){
  const aiDiv = document.getElementById('aiResult');
  const btn   = document.getElementById('aiSuggestBtn');
  if(!aiDiv || !btn) return;

  const toNum = (v) => {
    const m = (v ?? '').toString().match(/\d+(?:\.\d+)?/);
    return m ? Number(m[0]) : null;
  };

  // ---- Ä‘á»c field tá»« form
  const rawType = (document.getElementById('product_type')?.value || 'car').trim();
  const product_type = (rawType === 'battery') ? 'pin xe Ä‘iá»‡n' : 'xe';   // âœ… map Ä‘Ãºng chuá»—i backend

  const name         = (document.getElementById('name')?.value || '').trim();
  const brand        = (document.getElementById('brand')?.value || '').trim();
  const province     = (document.getElementById('province')?.value || '').trim();
  const year         = toNum(document.getElementById('year')?.value);
  const mileage      = toNum(document.getElementById('mileage')?.value);

  const capRaw       = (document.getElementById('battery_capacity')?.value || '').trim();
  const battery_capacity_kwh = toNum(capRaw);               // sá»‘ (náº¿u ngÆ°á»i dÃ¹ng gÃµ "42 kWh")
  const battery_capacity     = capRaw;                      // âœ… text Ä‘á»ƒ backend parse "60V 95Ah"

  const description  = (document.getElementById('description')?.value || '').trim();

  aiDiv.className = 'ai-msg muted';
  aiDiv.textContent = 'Äang phÃ¢n tÃ­châ€¦';
  btn.disabled = true;

  try{
    const payload = {
      product_type, name, brand, province,
      year, mileage, battery_capacity_kwh, battery_capacity, description
    };
    console.log("[AI PAYLOAD]", payload);

  const resp = await fetch('http://127.0.0.1:5003/predict', {
    method : 'POST',
    headers: { 'Content-Type': 'application/json' },
    body   : JSON.stringify({
      product_type, name, brand, province,
      year, mileage, battery_capacity_kwh, battery_capacity,
      description
  })
});


    const ct = resp.headers.get('content-type') || '';
    const data = ct.includes('application/json') ? await resp.json() : { error: await resp.text() };

    if (resp.ok && (data.suggested_price || data.suggestedPrice)) {
      const priceVal = data.suggested_price ?? data.suggestedPrice;
      const low  = data?.range?.low ?? data?.rangeLow ?? null;
      const high = data?.range?.high ?? data?.rangeHigh ?? null;

      const priceEl = document.getElementById('price');
      if (priceEl) priceEl.value = priceVal;

      aiDiv.className = 'ai-msg ok';
      aiDiv.textContent =
        `ğŸ’¡ AI gá»£i Ã½: ${Number(priceVal).toLocaleString('vi-VN')} Ä‘`
        + (low!=null && high!=null ? ` (khung ${Number(low).toLocaleString('vi-VN')}â€“${Number(high).toLocaleString('vi-VN')})` : '')
        + (data.explanation ? ` â€” ${data.explanation}` : '');
    } else {
      throw new Error(data.detail || data.error || 'AI tráº£ vá» lá»—i');
    }
  }catch(e){
    console.error('AI suggest error:', e);
    aiDiv.className = 'ai-msg err';
    aiDiv.textContent = 'âš ï¸ KhÃ´ng gá»i Ä‘Æ°á»£c AI gá»£i Ã½ giÃ¡. Thá»­ láº¡i sau.';
  }finally{
    btn.disabled = false;
  }
}
(() => {
  const btn = document.getElementById('aiSuggestBtn');
  if (!btn) return;
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    callAISuggest();
  });
})();
</script>
</body>
</html>