<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Second-hand EV & Battery Trading Platform</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      /* Action buttons styling */
      .product-actions {
        display: flex;
        gap: 6px;
        margin-top: 10px;
        align-items: center;
      }

      .action-btn {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 3px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      }

      .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
      }

      .action-btn:active {
        transform: translateY(0);
      }

      /* Heart button - larger with icon only */
      .btn-favorite {
        background: white;
        border: 1.5px solid #e0e0e0;
        padding: 8px;
        border-radius: 8px;
        min-width: 36px;
        height: 36px;
        position: relative;
      }

      .btn-favorite i {
        font-size: 16px;
        color: #666;
        transition: all 0.2s ease;
      }

      .btn-favorite:hover {
        border-color: #ff4757;
        background: #fff5f6;
      }

      .btn-favorite:hover i {
        color: #ff4757;
        transform: scale(1.1);
      }

      .btn-favorite.active i {
        color: #ff4757;
      }

      /* Compare and Buy buttons - smaller */
      .btn-compare,
      .btn-buy {
        flex: 1;
        font-size: 11px;
      }

      .btn-compare {
        background: #ffa726;
        color: white;
      }

      .btn-compare:hover {
        background: #fb8c00;
      }

      .btn-buy {
        background: #ff6f00;
        color: white;
        font-weight: 500;
      }

      .btn-buy:hover {
        background: #e65100;
      }

      .action-btn i {
        font-size: 10px;
      }

      .btn-favorite i {
        font-size: 16px !important;
      }

      @media (max-width: 768px) {
        .product-actions {
          flex-wrap: wrap;
        }
        .btn-favorite {
          flex-shrink: 0;
        }
      }

      /* Home button styling */
      .logo-home-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: linear-gradient(135deg, #ff6f00 0%, #ffa726 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(255, 111, 0, 0.2);
      }

      .logo-home-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(255, 111, 0, 0.3);
      }

      .logo-home-btn i {
        font-size: 18px;
      }

      /* Animation for auction badge */
      @keyframes swing {
        0%,
        100% {
          transform: rotate(-10deg);
        }
        50% {
          transform: rotate(10deg);
        }
      }

      /* Toast animations */
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      /* Search highlight animations */
      mark {
        animation: highlightFade 0.3s ease;
      }

      @keyframes highlightFade {
        0% {
          background: #fff;
        }
        100% {
          background: #ffeb3b;
        }
      }

      /* Enhanced search input styling */
      .location-search:focus {
        border-color: #ff6f00 !important;
        box-shadow: 0 0 0 3px rgba(255, 111, 0, 0.1);
      }

      /* Search result counter */
      .search-result-count {
        padding: 8px 12px;
        font-size: 12px;
        color: #666;
        background: #f5f5f5;
        border-radius: 6px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .search-result-count i {
        color: #ff6f00;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <div class="logo-section">
          <button class="menu-toggle"><i class="fas fa-bars"></i></button>
          <img src="/static/images/logo.png" alt="EV Trading" class="logo" />
        </div>

        <div class="user-menu">
          <a href="/policy" class="user-menu-item">Ch√≠nh s√°ch</a>
          <!-- Phi√™n ƒë·∫•u gi√° ƒë√£ hi·ªÉn th·ªã ·ªü trang ch·ªß, kh√¥ng c·∫ßn link ri√™ng -->
          <a href="/favorites" class="user-menu-item">Y√™u th√≠ch</a>
          <a href="/reviews" class="user-menu-item">ƒê√°nh gi√°</a>
          <a href="/transactions" class="user-menu-item">Giao d·ªãch</a>
          <a href="/cart" class="user-menu-item">Gi·ªè h√†ng</a>
          <a href="/checkout" class="user-menu-item">Thanh to√°n</a>
          <a href="#" class="user-menu-item"
            ><i class="far fa-comment"></i> Chat</a
          >
          <a href="#" class="user-menu-item"
            ><i class="far fa-bell"></i> Th√¥ng b√°o</a
          >

          {% if session.get('user') %}
          <div class="user-avatar-wrap">
            <button class="avatar-btn" onclick="toggleUserMenu(event)">
              <span class="avatar-circle" id="headerAvatarCircle">
                {{ (session['user'].get('username') or 'U')[:1] | upper }}
              </span>
            </button>
            <div id="userDropdown" class="user-dropdown" style="display: none">
              <div class="dropdown-name" id="headerUsername">
                {{ session['user'].get('username') }}
              </div>
              <a href="/profile" class="dropdown-item"
                ><i class="fas fa-user"></i> H·ªì s∆°</a
              >
              <a href="/transactions" class="dropdown-item"
                ><i class="fas fa-history"></i> L·ªãch s·ª≠ giao d·ªãch</a
              >
              <a href="{{ url_for('logout_page') }}" class="dropdown-item"
                ><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a
              >
            </div>
          </div>
          <a href="/add" class="post-button">ƒêƒÉng tin</a>
          {% else %}
          <a href="{{ url_for('login_page') }}" class="user-menu-item"
            >ƒêƒÉng nh·∫≠p</a
          >
          <a href="{{ url_for('register_page') }}" class="user-menu-item"
            >ƒêƒÉng k√Ω</a
          >
          {% endif %}
        </div>
      </div>
    </header>

    <section class="search-section">
      <div class="search-container">
        <h1 class="search-title">Second-hand EV & Battery Trading Platform</h1>
        <h2 class="search-subtitle">
          N·ªÅn t·∫£ng giao d·ªãch pin v√† xe ƒëi·ªán qua s·ª≠ d·ª•ng
        </h2>
        <div class="search-box-wrapper">
          <div class="search-box-unified">
            <!-- Search Icon -->
            <div class="search-icon">
              <i class="fas fa-search"></i>
            </div>

            <!-- Main Search Input -->
            <input
              id="qSearch"
              type="text"
              class="search-input-main"
              placeholder="T√¨m xe c·ªô..."
            />

            <!-- Divider -->
            <div class="search-divider"></div>

            <!-- Location Dropdown -->
            <div class="search-dropdown-wrapper">
              <button
                class="search-dropdown-btn"
                id="locationBtn"
                onclick="toggleLocationDropdown()"
              >
                <i class="fas fa-map-marker-alt"></i>
                <span id="locationText">H√† N·ªôi</span>
                <i class="fas fa-chevron-down"></i>
              </button>
              <div
                class="search-dropdown-menu"
                id="locationDropdown"
                style="display: none"
              >
                <div class="dropdown-header">
                  <h3>Khu v·ª±c</h3>
                </div>
                <div class="dropdown-content" style="padding-top: 8px">
                  <input
                    type="text"
                    class="location-search"
                    placeholder="T√¨m t·ªânh th√†nh..."
                    id="locationSearchInput"
                    oninput="filterLocations()"
                  />
                  <div class="location-options" id="locationList">
                    <label class="location-option selected">
                      <input type="radio" name="location" value="all" checked />
                      <span><i class="fas fa-check-circle"></i> To√†n qu·ªëc</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="hanoi" />
                      <span>H√† N·ªôi</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="hochiminh" />
                      <span>TP. H·ªì Ch√≠ Minh</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="danang" />
                      <span>ƒê√† N·∫µng</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="haiphong" />
                      <span>H·∫£i Ph√≤ng</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="cantho" />
                      <span>C·∫ßn Th∆°</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="binhduong" />
                      <span>B√¨nh D∆∞∆°ng</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="dongnai" />
                      <span>ƒê·ªìng Nai</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="khanhhoa" />
                      <span>Kh√°nh H√≤a</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="haiduong" />
                      <span>H·∫£i D∆∞∆°ng</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="nghean" />
                      <span>Ngh·ªá An</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="bacninh" />
                      <span>B·∫Øc Ninh</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="thanhhoa" />
                      <span>Thanh H√≥a</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="thaibinh" />
                      <span>Th√°i B√¨nh</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="namdinh" />
                      <span>Nam ƒê·ªãnh</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="quangninh" />
                      <span>Qu·∫£ng Ninh</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="hungyen" />
                      <span>H∆∞ng Y√™n</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="vinhphuc" />
                      <span>Vƒ©nh Ph√∫c</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="phutho" />
                      <span>Ph√∫ Th·ªç</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="quangnam" />
                      <span>Qu·∫£ng Nam</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="baria" />
                      <span>B√† R·ªãa - V≈©ng T√†u</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="tiengiang" />
                      <span>Ti·ªÅn Giang</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="bentre" />
                      <span>B·∫øn Tre</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="thainguyen" />
                      <span>Th√°i Nguy√™n</span>
                    </label>
                    <label class="location-option">
                      <input type="radio" name="location" value="longan" />
                      <span>Long An</span>
                    </label>
                  </div>
                </div>
                <div class="dropdown-footer">
                  <button class="dropdown-clear-btn" onclick="clearLocation()">
                    X√≥a l·ªçc
                  </button>
                  <button class="dropdown-apply-btn" onclick="applyLocation()">
                    √Åp d·ª•ng
                  </button>
                </div>
              </div>
            </div>

            <!-- Divider -->
            <div class="search-divider"></div>

            <!-- Product Type Dropdown -->
            <div class="search-dropdown-wrapper">
              <button
                class="search-dropdown-btn"
                id="typeBtn"
                onclick="toggleTypeDropdown()"
              >
                <i class="fas fa-car"></i>
                <span id="typeText">T·∫•t c·∫£ Xe c·ªô</span>
                <i class="fas fa-chevron-down"></i>
              </button>
              <div
                class="search-dropdown-menu"
                id="typeDropdown"
                style="display: none"
              >
                <div class="dropdown-header">
                  <h3>Ch·ªçn lo·∫°i & h√£ng</h3>
                </div>
                <div class="dropdown-content brands-grid-layout">
                  <!-- Lo·∫°i s·∫£n ph·∫©m Section -->
                  <div class="product-type-section">
                    <div class="section-title">üìã Lo·∫°i s·∫£n ph·∫©m</div>
                    <div class="location-options horizontal-options">
                      <label class="location-option selected">
                        <input
                          type="radio"
                          name="productType"
                          value="all"
                          checked
                        />
                        <span><i class="fas fa-check-circle"></i> T·∫•t c·∫£</span>
                      </label>
                      <label class="location-option">
                        <input
                          type="radio"
                          name="productType"
                          value="vehicle"
                        />
                        <span><i class="fas fa-check-circle"></i> Xe</span>
                      </label>
                      <label class="location-option">
                        <input
                          type="radio"
                          name="productType"
                          value="battery"
                        />
                        <span><i class="fas fa-check-circle"></i> Pin</span>
                      </label>
                    </div>
                  </div>

                  <!-- Brands Two Columns -->
                  <div class="brands-two-columns">
                    <!-- H√£ng xe Column -->
                    <div class="brand-column">
                      <div class="section-title">üöó H√£ng xe</div>
                      <input
                        type="text"
                        class="location-search"
                        placeholder="T√¨m h√£ng xe..."
                        id="vehicleBrandInput"
                        oninput="filterVehicleBrands()"
                      />
                      <div class="brand-count-info">
                        <i class="fas fa-car"></i> 10 h√£ng xe c√≥ s·∫µn
                      </div>
                      <div class="location-options" id="vehicleBrandList">
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="vehicleBrand"
                            value="vinfast"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i> VinFast</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="vehicleBrand"
                            value="tesla"
                          />
                          <span><i class="fas fa-check-circle"></i> Tesla</span>
                        </label>
                        <label class="location-option brand-option">
                          <input type="radio" name="vehicleBrand" value="byd" />
                          <span><i class="fas fa-check-circle"></i> BYD</span>
                        </label>
                        <label class="location-option brand-option">
                          <input type="radio" name="vehicleBrand" value="bmw" />
                          <span><i class="fas fa-check-circle"></i> BMW</span>
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="vehicleBrand"
                            value="mercedes"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i>
                            Mercedes-Benz</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="vehicleBrand"
                            value="audi"
                          />
                          <span><i class="fas fa-check-circle"></i> Audi</span>
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="vehicleBrand"
                            value="nissan"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i> Nissan</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="vehicleBrand"
                            value="hyundai"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i> Hyundai</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input type="radio" name="vehicleBrand" value="kia" />
                          <span><i class="fas fa-check-circle"></i> Kia</span>
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="vehicleBrand"
                            value="chevrolet"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i> Chevrolet</span
                          >
                        </label>
                      </div>
                    </div>

                    <!-- H√£ng pin Column -->
                    <div class="brand-column">
                      <div class="section-title">üîã H√£ng pin</div>
                      <input
                        type="text"
                        class="location-search"
                        placeholder="T√¨m h√£ng pin..."
                        id="batteryBrandInput"
                        oninput="filterBatteryBrands()"
                      />
                      <div class="brand-count-info">
                        <i class="fas fa-battery-full"></i> 10 h√£ng pin c√≥ s·∫µn
                      </div>
                      <div class="location-options" id="batteryBrandList">
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="batteryBrand"
                            value="catl"
                          />
                          <span><i class="fas fa-check-circle"></i> CATL</span>
                        </label>
                        <label class="location-option brand-option">
                          <input type="radio" name="batteryBrand" value="lg" />
                          <span
                            ><i class="fas fa-check-circle"></i> LG Energy
                            Solution</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="batteryBrand"
                            value="panasonic"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i> Panasonic</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="batteryBrand"
                            value="samsung"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i> Samsung
                            SDI</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input type="radio" name="batteryBrand" value="byd" />
                          <span
                            ><i class="fas fa-check-circle"></i> BYD
                            Battery</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input type="radio" name="batteryBrand" value="sk" />
                          <span
                            ><i class="fas fa-check-circle"></i> SK
                            Innovation</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="batteryBrand"
                            value="tesla"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i> Tesla
                            Battery</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="batteryBrand"
                            value="envision"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i> Envision
                            AESC</span
                          >
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="batteryBrand"
                            value="svolt"
                          />
                          <span><i class="fas fa-check-circle"></i> SVOLT</span>
                        </label>
                        <label class="location-option brand-option">
                          <input
                            type="radio"
                            name="batteryBrand"
                            value="gotion"
                          />
                          <span
                            ><i class="fas fa-check-circle"></i> Gotion
                            High-Tech</span
                          >
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="dropdown-footer">
                  <button class="dropdown-clear-btn" onclick="clearType()">
                    X√≥a l·ªçc
                  </button>
                  <button class="dropdown-apply-btn" onclick="applyType()">
                    √Åp d·ª•ng
                  </button>
                </div>
              </div>
            </div>

            <!-- Search Button -->
            <button class="search-button-unified" onclick="doSearch()">
              T√¨m xe
            </button>
          </div>

          <!-- Advanced Filters -->
          <div class="advanced-filters" id="advancedFilters">
            <button
              class="toggle-filters-btn"
              onclick="toggleAdvancedFilters()"
            >
              <i class="fas fa-sliders-h"></i> B·ªô l·ªçc n√¢ng cao
              <i class="fas fa-chevron-down filter-chevron"></i>
            </button>

            <div
              class="filters-content"
              id="filtersContent"
              style="display: none"
            >
              <!-- Vehicle Filters -->
              <div class="filter-group vehicle-filters">
                <div class="filter-group-title">
                  <i class="fas fa-car"></i> B·ªô l·ªçc xe ƒëi·ªán
                </div>
                <div class="filter-row">
                  <div class="filter-item">
                    <label>NƒÉm s·∫£n xu·∫•t</label>
                    <div class="filter-range">
                      <select id="yearFrom">
                        <option value="">T·ª´ nƒÉm</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                      </select>
                      <span class="range-separator">-</span>
                      <select id="yearTo">
                        <option value="">ƒê·∫øn nƒÉm</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                      </select>
                    </div>
                  </div>

                  <div class="filter-item">
                    <label>S·ªë km ƒë√£ ƒëi</label>
                    <div class="filter-range">
                      <input
                        type="number"
                        id="kmFrom"
                        placeholder="T·ª´ km"
                        min="0"
                        step="1000"
                      />
                      <span class="range-separator">-</span>
                      <input
                        type="number"
                        id="kmTo"
                        placeholder="ƒê·∫øn km"
                        min="0"
                        step="1000"
                      />
                    </div>
                  </div>

                  <div class="filter-item">
                    <label>Gi√° xe (tri·ªáu VNƒê)</label>
                    <div class="filter-range">
                      <input
                        type="number"
                        id="vehiclePriceFrom"
                        placeholder="T·ª´"
                        min="0"
                        step="10"
                      />
                      <span class="range-separator">-</span>
                      <input
                        type="number"
                        id="vehiclePriceTo"
                        placeholder="ƒê·∫øn"
                        min="0"
                        step="10"
                      />
                    </div>
                  </div>

                  <div class="filter-item">
                    <label>Dung l∆∞·ª£ng pin (kWh)</label>
                    <div class="filter-range">
                      <input
                        type="number"
                        id="batteryCapacityFrom"
                        placeholder="T·ª´"
                        min="0"
                        step="5"
                      />
                      <span class="range-separator">-</span>
                      <input
                        type="number"
                        id="batteryCapacityTo"
                        placeholder="ƒê·∫øn"
                        min="0"
                        step="5"
                      />
                    </div>
                  </div>
                </div>
                <div class="filter-row single-row">
                  <div class="filter-item">
                    <label>T√¨nh tr·∫°ng xe</label>
                    <select id="vehicleCondition">
                      <option value="">T·∫•t c·∫£</option>
                      <option value="new">M·ªõi</option>
                      <option value="like_new">Nh∆∞ m·ªõi</option>
                      <option value="good">T·ªët</option>
                      <option value="fair">Kh√°</option>
                      <option value="poor">C·∫ßn s·ª≠a ch·ªØa</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Battery Filters -->
              <div class="filter-group battery-filters">
                <div class="filter-group-title">
                  <i class="fas fa-battery-full"></i> B·ªô l·ªçc pin ƒëi·ªán
                </div>
                <div class="filter-row">
                  <div class="filter-item">
                    <label>Dung l∆∞·ª£ng pin (kWh)</label>
                    <div class="filter-range">
                      <input
                        type="number"
                        id="battOnlyCapacityFrom"
                        placeholder="T·ª´"
                        min="0"
                        step="5"
                      />
                      <span class="range-separator">-</span>
                      <input
                        type="number"
                        id="battOnlyCapacityTo"
                        placeholder="ƒê·∫øn"
                        min="0"
                        step="5"
                      />
                    </div>
                  </div>

                  <div class="filter-item">
                    <label>Gi√° pin (tri·ªáu VNƒê)</label>
                    <div class="filter-range">
                      <input
                        type="number"
                        id="batteryPriceFrom"
                        placeholder="T·ª´"
                        min="0"
                        step="5"
                      />
                      <span class="range-separator">-</span>
                      <input
                        type="number"
                        id="batteryPriceTo"
                        placeholder="ƒê·∫øn"
                        min="0"
                        step="5"
                      />
                    </div>
                  </div>

                  <div class="filter-item">
                    <label>S·ª©c kh·ªèe pin (%)</label>
                    <div class="filter-range">
                      <input
                        type="number"
                        id="healthFrom"
                        placeholder="T·ª´ %"
                        min="0"
                        max="100"
                        step="5"
                      />
                      <span class="range-separator">-</span>
                      <input
                        type="number"
                        id="healthTo"
                        placeholder="ƒê·∫øn %"
                        min="0"
                        max="100"
                        step="5"
                      />
                    </div>
                  </div>

                  <div class="filter-item">
                    <label>S·ªë chu k·ª≥ s·∫°c</label>
                    <div class="filter-range">
                      <input
                        type="number"
                        id="cyclesFrom"
                        placeholder="T·ª´"
                        min="0"
                        step="50"
                      />
                      <span class="range-separator">-</span>
                      <input
                        type="number"
                        id="cyclesTo"
                        placeholder="ƒê·∫øn"
                        min="0"
                        step="50"
                      />
                    </div>
                  </div>

                  <div class="filter-item">
                    <label>NƒÉm s·∫£n xu·∫•t pin</label>
                    <div class="filter-range">
                      <select id="batteryYearFrom">
                        <option value="">T·ª´ nƒÉm</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                      </select>
                      <span class="range-separator">-</span>
                      <select id="batteryYearTo">
                        <option value="">ƒê·∫øn nƒÉm</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <div class="filters-actions">
                <button
                  class="clear-filters-btn"
                  onclick="clearAdvancedFilters()"
                >
                  <i class="fas fa-redo"></i> X√≥a b·ªô l·ªçc
                </button>
                <button
                  class="apply-filters-btn"
                  onclick="applyAdvancedFilters()"
                >
                  <i class="fas fa-search"></i> √Åp d·ª•ng
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="product-section">
      <div class="section-header">
        <h2 class="section-title">Xe ƒëi·ªán n·ªïi b·∫≠t</h2>
        <a href="#" class="view-all">Xem t·∫•t c·∫£</a>
      </div>
      <div id="vehiclesGrid" class="product-grid"></div>
    </section>

    <!-- Active Auctions Section -->
    <section class="product-section" id="auctionsSection" style="display: none">
      <div class="section-header">
        <h2 class="section-title">Phi√™n ƒë·∫•u gi√° ƒëang di·ªÖn ra</h2>
        <span id="auctionsCount" class="view-all"></span>
      </div>
      <div id="auctionsGrid" class="product-grid"></div>
    </section>

    <section class="product-section">
      <div class="section-header">
        <h2 class="section-title">Pin xe ƒëi·ªán m·ªõi v·ªÅ</h2>
        <a href="#" class="view-all">Xem t·∫•t c·∫£</a>
      </div>
      <div id="batteriesGrid" class="product-grid"></div>
    </section>
    <div id="authModal" class="modal" style="display: none">
      <div class="modal-content">
        <span
          class="close"
          onclick="document.getElementById('authModal').style.display='none'"
          >&times;</span
        >
        <div class="auth-tabs">
          <button onclick="showTab('login')">ƒêƒÉng nh·∫≠p</button>
          <button onclick="showTab('register')">ƒêƒÉng k√Ω</button>
        </div>
        <div id="loginTab" class="tab-content">
          <form
            id="loginForm"
            method="POST"
            action="{{ url_for('login_page') }}"
          >
            <input type="email" name="email" placeholder="Email" required />
            <input
              type="password"
              name="password"
              placeholder="M·∫≠t kh·∫©u"
              required
            />
            <button type="submit">ƒêƒÉng nh·∫≠p</button>
          </form>
        </div>
        <div id="registerTab" class="tab-content" style="display: none">
          <form
            id="registerForm"
            method="POST"
            action="{{ url_for('register_page') }}"
          >
            <input type="email" name="email" placeholder="Email" required />
            <input
              type="text"
              name="phone"
              placeholder="S·ªë ƒëi·ªán tho·∫°i"
              required
            />
            <input
              type="password"
              name="password"
              placeholder="M·∫≠t kh·∫©u"
              required
            />
            <input
              type="password"
              name="confirmPassword"
              placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u"
              required
            />
            <button type="submit">ƒêƒÉng k√Ω</button>
          </form>
        </div>
      </div>
    </div>

    <div id="profileModal" class="modal" style="display: none">
      <div class="modal-content">
        <span
          class="close"
          onclick="document.getElementById('profileModal').style.display='none'"
          >&times;</span
        >
        <h2>H·ªì s∆° c√° nh√¢n</h2>
        <form id="profileForm">
          <input type="text" name="name" placeholder="T√™n" />
          <input type="date" name="dob" placeholder="Ng√†y sinh" />
          <input type="text" name="address" placeholder="ƒê·ªãa ch·ªâ" />
          <input type="file" name="avatar" accept="image/*" />
          <button type="submit">C·∫≠p nh·∫≠t h·ªì s∆°</button>
        </form>
        <div id="roleInfo"></div>
      </div>
    </div>

    <footer class="footer">
      <p>¬© 2025 EV Trading Platform. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
    </footer>

    <script>
      const fmtMoney = (v) => (v || 0).toLocaleString("vi-VN") + " ƒë";
      let auctionsMap = {}; // key: `${type}:${id}` => auction info
      let activeAuctions = []; // raw list for dedicated section

      function showTab(tab) {
        document.getElementById("loginTab").style.display =
          tab === "login" ? "block" : "none";
        document.getElementById("registerTab").style.display =
          tab === "register" ? "block" : "none";
      }
      function openAuthModal() {
        showTab("login");
        document.getElementById("authModal").style.display = "block";
      }
      function toggleUserMenu(e) {
        e.preventDefault();
        const dd = document.getElementById("userDropdown");
        dd.style.display =
          !dd.style.display || dd.style.display === "none" ? "block" : "none";
      }
      document.addEventListener("click", function (ev) {
        const wrap = document.querySelector(".user-avatar-wrap");
        const dd = document.getElementById("userDropdown");
        if (!wrap || !dd) return;
        if (!wrap.contains(ev.target)) dd.style.display = "none";
      });

      // Dropdown toggle functions
      let currentLocation = { province: null, district: null };
      let currentType = 'all';

      function toggleLocationDropdown() {
        const dropdown = document.getElementById('locationDropdown');
        const typeDropdown = document.getElementById('typeDropdown');
        typeDropdown.style.display = 'none';
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      }

      function toggleTypeDropdown() {
        const dropdown = document.getElementById('typeDropdown');
        const locationDropdown = document.getElementById('locationDropdown');
        locationDropdown.style.display = 'none';
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      }

      // Filter functions for search inputs - Google-style instant search
      function filterLocations() {
        const input = document.getElementById('locationSearchInput');
        const searchTerm = input.value.toLowerCase().trim();
        const options = document.querySelectorAll('#locationList .location-option');
        let visibleCount = 0;

        options.forEach(opt => {
          const span = opt.querySelector('span');
          const originalText = span.getAttribute('data-original') || span.textContent;

          // Store original text first time
          if (!span.getAttribute('data-original')) {
            span.setAttribute('data-original', span.textContent);
          }

          // Remove any existing highlights
          const textOnly = originalText.replace(/(<mark>|<\/mark>)/g, '');

          if (!searchTerm || textOnly.toLowerCase().includes(searchTerm)) {
            opt.style.display = 'flex';
            visibleCount++;

            // Highlight matching text
            if (searchTerm) {
              const regex = new RegExp(`(${searchTerm})`, 'gi');
              const highlighted = textOnly.replace(regex, '<mark style="background:#ffeb3b;padding:2px 4px;border-radius:3px;font-weight:600">$1</mark>');

              // Preserve icon if exists
              const icon = span.querySelector('i');
              span.innerHTML = highlighted;
              if (icon) span.insertBefore(icon, span.firstChild);
            } else {
              span.textContent = textOnly;
              // Restore icon if exists
              if (originalText.includes('‚úì') || opt.classList.contains('selected')) {
                span.innerHTML = '<i class="fas fa-check-circle"></i> ' + textOnly;
              }
            }
          } else {
            opt.style.display = 'none';
          }
        });

        // Show "no results" message
        showNoResults('locationList', visibleCount, 't·ªânh th√†nh');
      }

      function filterProducts() {
        const input = document.getElementById('productSearchInput');
        const searchTerm = input.value.toLowerCase().trim();
        const options = document.querySelectorAll('#productList .location-option');
        let visibleCount = 0;

        options.forEach(opt => {
          const span = opt.querySelector('span');
          const originalText = span.getAttribute('data-original') || span.textContent;

          if (!span.getAttribute('data-original')) {
            span.setAttribute('data-original', span.textContent);
          }

          const textOnly = originalText.replace(/(<mark>|<\/mark>)/g, '');

          if (!searchTerm || textOnly.toLowerCase().includes(searchTerm)) {
            opt.style.display = 'flex';
            visibleCount++;

            if (searchTerm) {
              const regex = new RegExp(`(${searchTerm})`, 'gi');
              const highlighted = textOnly.replace(regex, '<mark style="background:#ffeb3b;padding:2px 4px;border-radius:3px;font-weight:600">$1</mark>');
              const icon = span.querySelector('i');
              span.innerHTML = highlighted;
              if (icon) span.insertBefore(icon, span.firstChild);
            } else {
              span.textContent = textOnly;
              if (originalText.includes('‚úì') || opt.classList.contains('selected')) {
                span.innerHTML = '<i class="fas fa-check-circle"></i> ' + textOnly;
              }
            }
          } else {
            opt.style.display = 'none';
          }
        });

        showNoResults('productList', visibleCount, 'lo·∫°i s·∫£n ph·∫©m');
      }

      function filterVehicleBrands() {
        const input = document.getElementById('vehicleBrandInput');
        const searchTerm = input.value.toLowerCase().trim();
        const options = document.querySelectorAll('#vehicleBrandList .location-option');
        let visibleCount = 0;

        options.forEach(opt => {
          const span = opt.querySelector('span');
          const originalText = span.getAttribute('data-original') || span.textContent;

          if (!span.getAttribute('data-original')) {
            span.setAttribute('data-original', span.textContent);
          }

          const textOnly = originalText.replace(/(<mark>|<\/mark>)/g, '');

          if (!searchTerm || textOnly.toLowerCase().includes(searchTerm)) {
            opt.style.display = 'flex';
            visibleCount++;

            if (searchTerm) {
              const regex = new RegExp(`(${searchTerm})`, 'gi');
              const highlighted = textOnly.replace(regex, '<mark style="background:#ffeb3b;padding:2px 4px;border-radius:3px;font-weight:600">$1</mark>');
              span.innerHTML = highlighted;
            } else {
              span.textContent = textOnly;
            }
          } else {
            opt.style.display = 'none';
          }
        });

        showNoResults('vehicleBrandList', visibleCount, 'h√£ng xe');
      }

      function filterBatteryBrands() {
        const input = document.getElementById('batteryBrandInput');
        const searchTerm = input.value.toLowerCase().trim();
        const options = document.querySelectorAll('#batteryBrandList .location-option');
        let visibleCount = 0;

        options.forEach(opt => {
          const span = opt.querySelector('span');
          const originalText = span.getAttribute('data-original') || span.textContent;

          if (!span.getAttribute('data-original')) {
            span.setAttribute('data-original', span.textContent);
          }

          const textOnly = originalText.replace(/(<mark>|<\/mark>)/g, '');

          if (!searchTerm || textOnly.toLowerCase().includes(searchTerm)) {
            opt.style.display = 'flex';
            visibleCount++;

            if (searchTerm) {
              const regex = new RegExp(`(${searchTerm})`, 'gi');
              const highlighted = textOnly.replace(regex, '<mark style="background:#ffeb3b;padding:2px 4px;border-radius:3px;font-weight:600">$1</mark>');
              span.innerHTML = highlighted;
            } else {
              span.textContent = textOnly;
            }
          } else {
            opt.style.display = 'none';
          }
        });

        showNoResults('batteryBrandList', visibleCount, 'h√£ng pin');
      }

      // Helper function to show/hide "no results" message and update counter
      function showNoResults(listId, count, type) {
        const list = document.getElementById(listId);
        const container = list.parentElement;
        let noResultsDiv = list.querySelector('.no-results-message');
        let counterDiv = container.querySelector('.search-result-count');

        // Update or create counter
        if (count > 0) {
          if (!counterDiv) {
            counterDiv = document.createElement('div');
            counterDiv.className = 'search-result-count';
            container.insertBefore(counterDiv, list);
          }
          counterDiv.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>T√¨m th·∫•y <strong>${count}</strong> ${type}</span>
          `;
          counterDiv.style.display = 'flex';
        } else if (counterDiv) {
          counterDiv.style.display = 'none';
        }

        // Show/hide no results message
        if (count === 0) {
          if (!noResultsDiv) {
            noResultsDiv = document.createElement('div');
            noResultsDiv.className = 'no-results-message';
            noResultsDiv.style.cssText = 'padding:20px;text-align:center;color:#999;font-size:14px;';
            noResultsDiv.innerHTML = `
              <i class="fas fa-search" style="font-size:32px;color:#ddd;margin-bottom:8px;display:block;"></i>
              <div>Kh√¥ng t√¨m th·∫•y ${type} ph√π h·ª£p</div>
              <div style="font-size:12px;margin-top:8px;color:#bbb;">Th·ª≠ t·ª´ kh√≥a kh√°c</div>
            `;
            list.appendChild(noResultsDiv);
          }
          noResultsDiv.style.display = 'block';
        } else {
          if (noResultsDiv) {
            noResultsDiv.style.display = 'none';
          }
        }
      }

      function showTypeTab(tab) {
        document.querySelectorAll('.type-tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('#typeDropdown .dropdown-tab').forEach(t => t.classList.remove('active'));

        if (tab === 'product') {
          document.getElementById('productTypeTab').classList.add('active');
          document.querySelectorAll('#typeDropdown .dropdown-tab')[0].classList.add('active');
        } else if (tab === 'vehicle') {
          document.getElementById('vehicleTypeTab').classList.add('active');
          document.querySelectorAll('#typeDropdown .dropdown-tab')[1].classList.add('active');
        } else if (tab === 'battery') {
          document.getElementById('batteryTypeTab').classList.add('active');
          document.querySelectorAll('#typeDropdown .dropdown-tab')[2].classList.add('active');
        }
      }

      function clearLocation() {
        document.querySelector('input[name="location"][value="all"]').checked = true;
        document.querySelector('input[name="location"][value="all"]').closest('.location-option').classList.add('selected');
        document.getElementById('locationText').textContent = 'To√†n qu·ªëc';
        document.getElementById('locationDropdown').style.display = 'none';
      }

      function applyLocation() {
        const selected = document.querySelector('input[name="location"]:checked');
        if (selected) {
          const label = selected.parentElement.querySelector('span').textContent;
          document.getElementById('locationText').textContent = label.replace('‚úì ', '').trim();
        }
        document.getElementById('locationDropdown').style.display = 'none';
      }

      function clearType() {
        // Clear all radio buttons
        document.querySelectorAll('input[name="productType"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="vehicleBrand"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="batteryBrand"]').forEach(r => r.checked = false);

        // Set default
        const allRadio = document.querySelector('input[name="productType"][value="all"]');
        if (allRadio) {
          allRadio.checked = true;
          allRadio.closest('.location-option').classList.add('selected');
        }

        document.getElementById('typeText').textContent = 'T·∫•t c·∫£ Xe & Pin';
        document.getElementById('typeDropdown').style.display = 'none';
      }

      function applyType() {
        let selectedText = 'T·∫•t c·∫£ Xe & Pin';

        // Check product type
        const productType = document.querySelector('input[name="productType"]:checked');
        if (productType) {
          selectedText = productType.parentElement.querySelector('span').textContent.replace('‚úì ', '').trim();
        }

        // Check vehicle brand
        const vehicleBrand = document.querySelector('input[name="vehicleBrand"]:checked');
        if (vehicleBrand) {
          selectedText = vehicleBrand.parentElement.querySelector('span').textContent.trim();
        }

        // Check battery brand
        const batteryBrand = document.querySelector('input[name="batteryBrand"]:checked');
        if (batteryBrand) {
          selectedText = batteryBrand.parentElement.querySelector('span').textContent.trim();
        }

        document.getElementById('typeText').textContent = selectedText;
        document.getElementById('typeDropdown').style.display = 'none';
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        const locationWrapper = document.querySelector('.search-dropdown-wrapper');
        const locationDropdown = document.getElementById('locationDropdown');
        const typeDropdown = document.getElementById('typeDropdown');

        if (!e.target.closest('.search-dropdown-wrapper')) {
          if (locationDropdown) locationDropdown.style.display = 'none';
          if (typeDropdown) typeDropdown.style.display = 'none';
        }
      });

      // Handle radio button selection styling
      document.addEventListener('change', function(e) {
        if (e.target.type === 'radio' && (e.target.name === 'productType' || e.target.name === 'location' || e.target.name === 'vehicleBrand' || e.target.name === 'batteryBrand')) {
          const container = e.target.closest('.location-options');
          if (container) {
            container.querySelectorAll('.location-option').forEach(opt => opt.classList.remove('selected'));
            e.target.closest('.location-option').classList.add('selected');
          }
        }
      });

      async function doSearch() {
        const searchText = document.getElementById("qSearch")?.value.trim() || "";

        // Get selected filters from dropdowns
        const productType = document.querySelector('input[name="productType"]:checked')?.value || 'all';
        const vehicleBrand = document.querySelector('input[name="vehicleBrand"]:checked')?.parentElement.querySelector('span')?.textContent.trim() || '';
        const batteryBrand = document.querySelector('input[name="batteryBrand"]:checked')?.parentElement.querySelector('span')?.textContent.trim() || '';
        const location = document.querySelector('input[name="location"]:checked')?.value || 'all';

        // load active auctions first
        auctionsMap = {};
        activeAuctions = [];
        try {
          const ar = await fetch("/api/auctions/active");
          if (ar.ok) {
            const aj = await ar.json();
            activeAuctions = aj.data || [];
            activeAuctions.forEach((a) => {
              auctionsMap[`${a.item_type}:${a.item_id}`] = a;
            });
          }
        } catch (e) {}
        // render dedicated auctions section (independent of search results)
        renderActiveAuctions(activeAuctions);

        // Build search params based on filters
        let shouldShowVehicles = productType === 'all' || productType === 'vehicle';
        let shouldShowBatteries = productType === 'all' || productType === 'battery';

        // If vehicle brand is selected, only show vehicles
        if (vehicleBrand) {
          shouldShowVehicles = true;
          shouldShowBatteries = false;
        }

        // If battery brand is selected, only show batteries
        if (batteryBrand) {
          shouldShowVehicles = false;
          shouldShowBatteries = true;
        }

        // Vehicles search
        if (shouldShowVehicles) {
          const vUrl = new URL("/api/search/vehicles", window.location.origin);

          // Add search text - only if no brand filter selected
          if (searchText && !vehicleBrand) {
            vUrl.searchParams.set("brand", searchText);
          }

          // Add brand filter from dropdown
          if (vehicleBrand) {
            vUrl.searchParams.set("brand", vehicleBrand);
          }

          // Add advanced filters
          const yearFrom = document.getElementById('yearFrom')?.value;
          const yearTo = document.getElementById('yearTo')?.value;
          const kmFrom = document.getElementById('kmFrom')?.value;
          const kmTo = document.getElementById('kmTo')?.value;
          const vehiclePriceFrom = document.getElementById('vehiclePriceFrom')?.value;
          const vehiclePriceTo = document.getElementById('vehiclePriceTo')?.value;
          const batteryCapacityFrom = document.getElementById('batteryCapacityFrom')?.value;
          const batteryCapacityTo = document.getElementById('batteryCapacityTo')?.value;
          const vehicleCondition = document.getElementById('vehicleCondition')?.value;

          if (yearFrom) vUrl.searchParams.set("year_min", yearFrom);
          if (yearTo) vUrl.searchParams.set("year_max", yearTo);
          if (kmFrom) vUrl.searchParams.set("km_min", kmFrom);
          if (kmTo) vUrl.searchParams.set("km_max", kmTo);
          if (vehiclePriceFrom) vUrl.searchParams.set("price_min", parseFloat(vehiclePriceFrom) * 1000000);
          if (vehiclePriceTo) vUrl.searchParams.set("price_max", parseFloat(vehiclePriceTo) * 1000000);
          if (batteryCapacityFrom) vUrl.searchParams.set("battery_capacity_min", batteryCapacityFrom);
          if (batteryCapacityTo) vUrl.searchParams.set("battery_capacity_max", batteryCapacityTo);
          if (vehicleCondition) vUrl.searchParams.set("condition", vehicleCondition);

          console.log('Vehicle search URL:', vUrl.toString());

          const vRes = await fetch(vUrl)
            .then((r) => r.json())
            .catch(() => ({ items: [] }));
          console.log('Vehicle results:', vRes.items?.length || 0, 'items');
          renderVehicles(vRes.items || []);
        } else {
          renderVehicles([]);
        }

        // Batteries search
        if (shouldShowBatteries) {
          const bUrl = new URL("/api/search/batteries", window.location.origin);

          // Add search text - only if no brand filter selected
          if (searchText && !batteryBrand) {
            bUrl.searchParams.set("brand", searchText);
          }

          // Add brand filter from dropdown
          if (batteryBrand) {
            bUrl.searchParams.set("brand", batteryBrand);
          }

          // Add advanced filters
          const battOnlyCapacityFrom = document.getElementById('battOnlyCapacityFrom')?.value;
          const battOnlyCapacityTo = document.getElementById('battOnlyCapacityTo')?.value;
          const batteryPriceFrom = document.getElementById('batteryPriceFrom')?.value;
          const batteryPriceTo = document.getElementById('batteryPriceTo')?.value;
          const healthFrom = document.getElementById('healthFrom')?.value;
          const healthTo = document.getElementById('healthTo')?.value;
          const cyclesFrom = document.getElementById('cyclesFrom')?.value;
          const cyclesTo = document.getElementById('cyclesTo')?.value;
          const batteryYearFrom = document.getElementById('batteryYearFrom')?.value;
          const batteryYearTo = document.getElementById('batteryYearTo')?.value;

          if (battOnlyCapacityFrom) bUrl.searchParams.set("capacity_min", battOnlyCapacityFrom);
          if (battOnlyCapacityTo) bUrl.searchParams.set("capacity_max", battOnlyCapacityTo);
          if (batteryPriceFrom) bUrl.searchParams.set("price_min", parseFloat(batteryPriceFrom) * 1000000);
          if (batteryPriceTo) bUrl.searchParams.set("price_max", parseFloat(batteryPriceTo) * 1000000);
          if (healthFrom) bUrl.searchParams.set("health_min", healthFrom);
          if (healthTo) bUrl.searchParams.set("health_max", healthTo);
          if (cyclesFrom) bUrl.searchParams.set("cycles_min", cyclesFrom);
          if (cyclesTo) bUrl.searchParams.set("cycles_max", cyclesTo);
          if (batteryYearFrom) bUrl.searchParams.set("year_min", batteryYearFrom);
          if (batteryYearTo) bUrl.searchParams.set("year_max", batteryYearTo);

          console.log('Battery search URL:', bUrl.toString());

          const bRes = await fetch(bUrl)
            .then((r) => r.json())
            .catch(() => ({ items: [] }));
          console.log('Battery results:', bRes.items?.length || 0, 'items');
          renderBatteries(bRes.items || []);
        } else {
          renderBatteries([]);
        }
      }

      /*
       * ==============================================
       * RENDER ACTIVE AUCTIONS - Hi·ªÉn th·ªã phi√™n ƒë·∫•u gi√° ·ªü trang ch·ªß
       * ==============================================
       *
       * H∆Ø·ªöNG D·∫™N CHO TEAMMATE L√ÄM PH·∫¶N ƒêƒÇNG TIN:
       *
       * 1. Khi user ƒëƒÉng tin xe/pin, cho option checkbox "ƒê·∫•u gi√°"
       * 2. N·∫øu ch·ªçn ƒë·∫•u gi√°, hi·ªán th√™m 3 field:
       *    - Gi√° kh·ªüi ƒëi·ªÉm (starting_price): b·∫Øt bu·ªôc
       *    - Gi√° mua ngay (buy_now_price): t√πy ch·ªçn, c√≥ th·ªÉ ƒë·ªÉ null
       *    - Th·ªùi gian k·∫øt th√∫c (ends_at): datetime picker
       *
       * 3. Sau khi t·∫°o xe/pin th√†nh c√¥ng (c√≥ item_id), g·ªçi API:
       *    POST /api/auctions/create
       *    Body: {
       *      "item_type": "vehicle" ho·∫∑c "battery",
       *      "item_id": <id v·ª´a t·∫°o>,
       *      "seller_id": <user_id hi·ªán t·∫°i>,
       *      "starting_price": <s·ªë nguy√™n VND>,
       *      "buy_now_price": <s·ªë nguy√™n VND ho·∫∑c null>,
       *      "ends_at": "2025-10-25T18:00:00" (ISO format)
       *    }
       *
       * 4. Phi√™n ƒë·∫•u gi√° s·∫Ω t·ª± ƒë·ªông hi·ªán ·ªü trang ch·ªß section n√†y
       *
       * NOTE: Code d∆∞·ªõi ƒë√¢y render c√°c card ƒë·∫•u gi√° v·ªõi:
       * - Badge "ƒêANG ƒê·∫§U GI√Å" m√†u cam
       * - Countdown timer ƒë·ªông
       * - N√∫t "ƒê·∫•u gi√°" v√† "Mua ngay" (n·∫øu c√≥)
       * ==============================================
       */
      async function renderActiveAuctions(list) {
        const section = document.getElementById("auctionsSection");
        const grid = document.getElementById("auctionsGrid");
        const count = document.getElementById("auctionsCount");
        section.style.display = "block";
        grid.innerHTML = "";

        if (!list || list.length === 0) {
          if (count) count.textContent = "";
          const empty = document.createElement("div");
          empty.style.cssText =
            "padding:40px;color:#999;text-align:center;width:100%;background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06)";
          empty.innerHTML = `
            <i class="fas fa-gavel" style="font-size:48px;color:#e0e0e0;margin-bottom:12px"></i>
            <p style="margin:0;font-size:16px">Ch∆∞a c√≥ phi√™n ƒë·∫•u gi√° n√†o</p>
            <p style="margin:8px 0 0;font-size:14px;color:#bbb">C√°c phi√™n ƒë·∫•u gi√° m·ªõi s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y</p>
          `;
          grid.appendChild(empty);
          return;
        }

        if (count) count.textContent = `üî• ${list.length} phi√™n ƒëang hot`;

        // Fetch item details for richer display
        const enriched = await Promise.all(
          list.map(async (a) => {
            let info = null;
            try {
              const url =
                a.item_type === "vehicle"
                  ? `/api/listings/vehicles/${a.item_id}`
                  : `/api/listings/batteries/${a.item_id}`;
              const r = await fetch(url);
              if (r.ok) info = await r.json();
            } catch (e) {}
            return { a, info };
          })
        );

        enriched.forEach(({ a, info }) => {
          const ends = a ? new Date(a.ends_at) : null;
          const now = new Date();
          const remaining =
            a && ends ? Math.max(0, Math.floor((ends - now) / 1000)) : 0;

          // Format countdown timer
          const hours = Math.floor(remaining / 3600);
          const mins = Math.floor((remaining % 3600) / 60);
          const secs = remaining % 60;
          const remStr = `${String(hours).padStart(2, "0")}:${String(
            mins
          ).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;

          const card = document.createElement("div");
          card.className = "product-card";
          card.style.position = "relative";

          const title =
            a.item_type === "vehicle"
              ? info
                ? `${info.brand || ""} ${info.model || ""} ${info.year || ""}`
                : `Xe #${a.item_id}`
              : info
              ? `${info.brand || ""} ${info.year || ""} - ${
                  info.capacity_kwh || ""
                } kWh`
              : `Pin #${a.item_id}`;

          const currentPrice =
            a.highest_bid != null ? a.highest_bid : a.starting_price;
          const priceLabel =
            a.highest_bid != null ? "Gi√° cao nh·∫•t" : "Gi√° kh·ªüi ƒëi·ªÉm";

          const img =
            a.item_type === "vehicle"
              ? "/static/images/v1.jpg"
              : "/static/images/v3.jpg";

          card.innerHTML = `
            <!-- Auction Badge -->
            <div style="position:absolute;top:12px;left:12px;background:linear-gradient(135deg,#ff6f00,#ff8f00);color:white;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:700;z-index:10;box-shadow:0 2px 8px rgba(255,111,0,0.4);display:flex;align-items:center;gap:6px">
              <i class="fas fa-gavel" style="animation:swing 1s ease-in-out infinite"></i>
              <span>ƒê·∫§U GI√Å</span>
            </div>

            <img src="${img}" alt="auction" class="product-image" style="cursor:pointer" onclick="window.location.href='/auctions/${
            a.id
          }'"/>

            <div class="product-info">
              <h3 class="product-title" style="cursor:pointer" onclick="window.location.href='/auctions/${
                a.id
              }'">${title}</h3>

              <!-- Price Box -->
              <div style="background:linear-gradient(135deg,#fff3e0,#ffe0b2);padding:12px;border-radius:8px;margin:8px 0">
                <div style="font-size:11px;color:#666;font-weight:600;text-transform:uppercase;margin-bottom:4px">${priceLabel}</div>
                <div class="product-price" style="display:flex;align-items:center;gap:6px">
                  <i class="fas fa-tag"></i>
                  ${fmtMoney(currentPrice)}
                </div>
              </div>

              <!-- Countdown Timer -->
              <div style="display:flex;align-items:center;gap:8px;padding:10px;background:#f8f9fa;border-radius:8px;border-left:3px solid #ff6f00;margin:8px 0">
                <i class="far fa-clock" style="font-size:16px;color:#ff6f00"></i>
                <div style="flex:1">
                  <div style="font-size:11px;color:#666">C√≤n l·∫°i</div>
                  <div id="timer-${
                    a.id
                  }" style="font-size:16px;font-weight:700;color:#e53935;font-family:monospace">${remStr}</div>
                </div>
              </div>

              <div class="product-actions">
                <button class="action-btn btn-compare" onclick="event.stopPropagation();placeBid(${
                  a.id
                })">
                  <i class='fas fa-gavel'></i> ƒê·∫•u gi√°
                </button>
                ${
                  a.buy_now_price
                    ? `<button class="action-btn btn-buy" onclick="event.stopPropagation();buyNowAuction(${a.id})">
                        <i class='fas fa-bolt'></i> Mua ngay
                      </button>`
                    : ""
                }
              </div>
            </div>
          `;
          grid.appendChild(card);

          // Start real-time countdown
          if (remaining > 0) {
            const timerEl = card.querySelector(`#timer-${a.id}`);
            let timeLeft = remaining;
            const interval = setInterval(() => {
              timeLeft--;
              if (timeLeft <= 0) {
                clearInterval(interval);
                timerEl.textContent = "00:00:00";
                timerEl.style.color = "#999";
                return;
              }
              const h = Math.floor(timeLeft / 3600);
              const m = Math.floor((timeLeft % 3600) / 60);
              const s = timeLeft % 60;
              timerEl.textContent = `${String(h).padStart(2, "0")}:${String(
                m
              ).padStart(2, "0")}:${String(s).padStart(2, "0")}`;

              // Color change based on urgency
              if (timeLeft < 300) timerEl.style.color = "#e53935";
              else if (timeLeft < 3600) timerEl.style.color = "#ff9800";
            }, 1000);
          }
        });
      }

      function renderVehicles(items) {
        const root = document.getElementById("vehiclesGrid");
        root.innerHTML = "";
        items.forEach((v) => {
          const card = document.createElement("div");
          card.className = "product-card";
          const akey = `vehicle:${v.id}`;
          const a = auctionsMap[akey];
          const ends = a ? new Date(a.ends_at) : null;
          const now = new Date();
          const remaining =
            a && ends ? Math.max(0, Math.floor((ends - now) / 1000)) : 0;
          const remStr = a
            ? new Date(remaining * 1000).toISOString().substring(11, 19)
            : "";
          card.innerHTML = `
          <img src="/static/images/v1.jpg" alt="${v.brand} ${
            v.model
          }" class="product-image"/>
          <div class="product-info">
            <h3 class="product-title">${v.brand} ${v.model} ${v.year || ""}</h3>
            <div class="product-price">${fmtMoney(v.price)}</div>
            <div class="product-location"><i class="fas fa-battery-full"></i> ${
              v.battery_capacity_kwh || ""
            } kWh - ${v.km || 0} km</div>
            ${
              a
                ? `<div class="product-auction" style="display:flex;justify-content:space-between;align-items:center;background:#fff3e0;border:1px dashed #ffb74d;border-radius:8px;padding:6px 8px;margin-top:8px;font-size:12px;">
                    <div style="display:flex;gap:12px;align-items:center;">
                      <span><i class='far fa-clock'></i> ${remStr}</span>
                      <span><i class='fas fa-trophy'></i> ${
                        a.highest_bid != null
                          ? fmtMoney(a.highest_bid)
                          : fmtMoney(a.starting_price)
                      }</span>
                    </div>
                    <div style="display:flex;gap:6px;">
                      <button class="action-btn" onclick="placeBid(${
                        a.id
                      })"><i class='fas fa-gavel'></i> ƒê·∫•u gi√°</button>
                      ${
                        a.buy_now_price
                          ? `<button class="action-btn btn-buy" onclick="buyNowAuction(${a.id})"><i class='fas fa-bolt'></i> Mua ngay</button>`
                          : ""
                      }
                    </div>
                   </div>`
                : ""
            }
            <div class="product-actions">
              <button class="action-btn btn-favorite" onclick="addFav('vehicle', ${v.id}, this)" title="Y√™u th√≠ch">
                <i class="far fa-heart"></i>
              </button>
              <button class="action-btn btn-buy" onclick="buyNow('vehicle', ${
                v.id
              }, ${v.seller_id || 1}, ${
            v.price || 0
          })"><i class="fas fa-shopping-cart"></i> Mua ngay</button>
            </div>
          </div>
        `;
          root.appendChild(card);
        });
      }

      function renderBatteries(items) {
        const root = document.getElementById("batteriesGrid");
        root.innerHTML = "";
        items.forEach((b) => {
          const card = document.createElement("div");
          card.className = "product-card";
          const akey = `battery:${b.id}`;
          const a = auctionsMap[akey];
          const ends = a ? new Date(a.ends_at) : null;
          const now = new Date();
          const remaining =
            a && ends ? Math.max(0, Math.floor((ends - now) / 1000)) : 0;
          const remStr = a
            ? new Date(remaining * 1000).toISOString().substring(11, 19)
            : "";
          card.innerHTML = `
          <img src="/static/images/v3.jpg" alt="${b.brand} ${
            b.capacity_kwh
          } kWh" class="product-image"/>
          <div class="product-info">
            <h3 class="product-title">${b.brand} ${b.year || ""} - ${
            b.capacity_kwh || ""
          } kWh</h3>
            <div class="product-price">${fmtMoney(b.price)}</div>
            <div class="product-location"><i class="fas fa-heartbeat"></i> ${
              b.health_percent || ""
            }% - ${b.cycles || 0} chu k·ª≥</div>
            ${
              a
                ? `<div class="product-auction" style="display:flex;justify-content:space-between;align-items:center;background:#fff3e0;border:1px dashed #ffb74d;border-radius:8px;padding:6px 8px;margin-top:8px;font-size:12px;">
                    <div style="display:flex;gap:12px;align-items:center;">
                      <span><i class='far fa-clock'></i> ${remStr}</span>
                      <span><i class='fas fa-trophy'></i> ${
                        a.highest_bid != null
                          ? fmtMoney(a.highest_bid)
                          : fmtMoney(a.starting_price)
                      }</span>
                    </div>
                    <div style="display:flex;gap:6px;">
                      <button class="action-btn" onclick="placeBid(${
                        a.id
                      })"><i class='fas fa-gavel'></i> ƒê·∫•u gi√°</button>
                      ${
                        a.buy_now_price
                          ? `<button class="action-btn btn-buy" onclick="buyNowAuction(${a.id})"><i class='fas fa-bolt'></i> Mua ngay</button>`
                          : ""
                      }
                    </div>
                   </div>`
                : ""
            }
            <div class="product-actions">
              <button class="action-btn btn-favorite" onclick="addFav('battery', ${b.id}, this)" title="Y√™u th√≠ch">
                <i class="far fa-heart"></i>
              </button>
              <button class="action-btn btn-buy" onclick="buyNow('battery', ${
                b.id
              }, ${b.seller_id || 1}, ${
            b.price || 0
          })"><i class="fas fa-shopping-cart"></i> Mua ngay</button>
            </div>
          </div>
        `;
          root.appendChild(card);
        });
      }

      async function addFav(item_type, item_id, btn) {
        // Check if user is logged in first
        {% if not session.get('user') %}
        if (confirm("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u y√™u th√≠ch. Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p?")) {
          window.location.href = "/login?next=" + encodeURIComponent(window.location.pathname);
        }
        return;
        {% endif %}

        const button = btn || event.target.closest('.btn-favorite');
        const isActive = button.classList.contains('active');

        try {
          // N·∫øu ƒë√£ c√≥ trong favorites ‚Üí X√≥a (toggle off)
          if (isActive && button.dataset.favId) {
            const res = await fetch(`/api/favorites/${button.dataset.favId}`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" }
            });

            if (res.ok) {
              button.classList.remove('active');
              delete button.dataset.favId;
              // Show toast instead of alert
              showToast("üíî ƒê√£ x√≥a kh·ªèi y√™u th√≠ch", "info");
            } else {
              showToast("‚ùå Kh√¥ng th·ªÉ x√≥a", "error");
            }
            return;
          }

          // N·∫øu ch∆∞a c√≥ ‚Üí Th√™m v√†o favorites
          const res = await fetch("/api/favorites", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ item_type, item_id }),
          });

          if (res.ok) {
            const data = await res.json();
            button.classList.add('active');
            button.dataset.favId = data.id || data.favorite_id || '';
            showToast("‚ù§Ô∏è ƒê√£ th√™m v√†o y√™u th√≠ch!", "success");
          } else {
            const error = await res.json().catch(() => ({}));
            if (res.status === 401) {
              if (confirm("Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. ƒêƒÉng nh·∫≠p l·∫°i?")) {
                window.location.href = "/login?next=" + encodeURIComponent(window.location.pathname);
              }
            } else if (res.status === 409) {
              // S·∫£n ph·∫©m ƒë√£ c√≥ trong favorites
              button.classList.add('active');
              showToast("‚ö†Ô∏è S·∫£n ph·∫©m ƒë√£ c√≥ trong danh s√°ch y√™u th√≠ch!", "warning");
            } else {
              showToast("‚ùå " + (error.message || error.error || "Kh√¥ng th·ªÉ th√™m y√™u th√≠ch"), "error");
            }
          }
        } catch (err) {
          console.error("Favorite error:", err);
          showToast("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.", "error");
        }
      }

      // Toast notification helper
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          z-index: 10000;
          animation: slideIn 0.3s ease;
          font-weight: 500;
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "slideOut 0.3s ease";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Compare feature ƒë√£ chuy·ªÉn sang trang Y√™u th√≠ch

      async function buyNow(item_type, item_id, seller_id, price) {
        // Add to session cart then go to cart page
        const add = await fetch("/cart/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            item_type,
            item_id,
            seller_id,
            price,
            qty: 1,
          }),
        });
        if (add.ok) {
          window.location.href = "/cart";
        } else {
          alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua ngay.");
        }
      }

      async function placeBid(aid) {
        const val = prompt("Nh·∫≠p gi√° b·∫°n mu·ªën ƒë·∫∑t (ƒë∆°n v·ªã: ƒë)");
        if (!val) return;
        const amount = parseInt(val.replace(/\D/g, ""), 10) || 0;
        if (amount <= 0) return alert("Gi√° kh√¥ng h·ª£p l·ªá");
        const res = await fetch(`/api/auctions/${aid}/bid`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount }),
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          alert("ƒê√£ ƒë·∫∑t gi√° th√†nh c√¥ng!");
          doSearch();
        } else if (data && data.error === "low_bid") {
          alert("Gi√° qu√° th·∫•p. T·ªëi thi·ªÉu: " + fmtMoney(data.min || 0));
        } else if (res.status === 401) {
          alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫•u gi√°.");
          window.location.href = "/login";
        } else {
          alert("Kh√¥ng th·ªÉ ƒë·∫∑t gi√° l√∫c n√†y.");
        }
      }

      async function buyNowAuction(aid) {
        if (!confirm("X√°c nh·∫≠n Mua ngay v√† k·∫øt th√∫c phi√™n ƒë·∫•u gi√°?")) return;
        const res = await fetch(`/api/auctions/${aid}/buy-now`, {
          method: "POST",
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          const price = (data && (data.final_price ?? data.buy_now_price)) || 0;
          if (data && data.item_type && data.item_id) {
            const add = await fetch("/cart/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                item_type: data.item_type,
                item_id: data.item_id,
                seller_id: data.seller_id,
                price,
                qty: 1,
              }),
            });
            if (add.ok) {
              alert(
                "Phi√™n ƒë·∫•u gi√° ƒë√£ k·∫øt th√∫c. S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c ƒë∆∞a v√†o gi·ªè h√†ng."
              );
              window.location.href = "/cart";
              return;
            }
            if (add.status === 401) {
              alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ho√†n t·∫•t Mua ngay.");
              window.location.href = "/login";
              return;
            }
          }
          alert("Phi√™n ƒë·∫•u gi√° ƒë√£ k·∫øt th√∫c.");
          doSearch();
        } else if (res.status === 401) {
          alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ Mua ngay.");
          window.location.href = "/login";
        } else {
          alert("Kh√¥ng th·ªÉ Mua ngay l√∫c n√†y.");
        }
      }

      // Handle product type selection to show/hide brand columns
      function handleProductTypeChange() {
        const selectedType = document.querySelector('input[name="productType"]:checked')?.value || 'all';
        const vehicleColumn = document.querySelector('.brands-two-columns .brand-column:first-child');
        const batteryColumn = document.querySelector('.brands-two-columns .brand-column:last-child');
        const vehicleFilters = document.querySelector('.vehicle-filters');
        const batteryFilters = document.querySelector('.battery-filters');

        if (selectedType === 'all') {
          // Show both columns and filters
          if (vehicleColumn) vehicleColumn.style.display = 'flex';
          if (batteryColumn) batteryColumn.style.display = 'flex';
          if (vehicleFilters) vehicleFilters.style.display = 'block';
          if (batteryFilters) batteryFilters.style.display = 'block';
        } else if (selectedType === 'vehicle') {
          // Show only vehicle column and filters
          if (vehicleColumn) vehicleColumn.style.display = 'flex';
          if (batteryColumn) batteryColumn.style.display = 'none';
          if (vehicleFilters) vehicleFilters.style.display = 'block';
          if (batteryFilters) batteryFilters.style.display = 'none';
        } else if (selectedType === 'battery') {
          // Show only battery column and filters
          if (vehicleColumn) vehicleColumn.style.display = 'none';
          if (batteryColumn) batteryColumn.style.display = 'flex';
          if (vehicleFilters) vehicleFilters.style.display = 'none';
          if (batteryFilters) batteryFilters.style.display = 'block';
        }
      }

      // Add event listeners to product type radio buttons
      document.querySelectorAll('input[name="productType"]').forEach(radio => {
        radio.addEventListener('change', handleProductTypeChange);
      });

      // Toggle advanced filters
      function toggleAdvancedFilters() {
        const content = document.getElementById('filtersContent');
        const btn = document.querySelector('.toggle-filters-btn');

        if (content.style.display === 'none') {
          content.style.display = 'block';
          btn.classList.add('active');
        } else {
          content.style.display = 'none';
          btn.classList.remove('active');
        }
      }

      // Clear advanced filters
      function clearAdvancedFilters() {
        // Vehicle filters
        document.getElementById('yearFrom').value = '';
        document.getElementById('yearTo').value = '';
        document.getElementById('kmFrom').value = '';
        document.getElementById('kmTo').value = '';
        document.getElementById('vehiclePriceFrom').value = '';
        document.getElementById('vehiclePriceTo').value = '';
        document.getElementById('batteryCapacityFrom').value = '';
        document.getElementById('batteryCapacityTo').value = '';
        document.getElementById('vehicleCondition').value = '';

        // Battery filters
        document.getElementById('battOnlyCapacityFrom').value = '';
        document.getElementById('battOnlyCapacityTo').value = '';
        document.getElementById('batteryPriceFrom').value = '';
        document.getElementById('batteryPriceTo').value = '';
        document.getElementById('healthFrom').value = '';
        document.getElementById('healthTo').value = '';
        document.getElementById('cyclesFrom').value = '';
        document.getElementById('cyclesTo').value = '';
        document.getElementById('batteryYearFrom').value = '';
        document.getElementById('batteryYearTo').value = '';
      }

      // Apply advanced filters
      function applyAdvancedFilters() {
        doSearch();
      }

      // Load fresh user profile data and update header
      async function refreshUserHeader() {
        try {
          const res = await fetch('/api/profile', {
            credentials: 'include'
          });
          if (res.ok) {
            const data = await res.json();
            const profile = data.profile || {};
            const user = data.user || {};

            // Update username in dropdown
            const usernameEl = document.getElementById('headerUsername');
            if (usernameEl) {
              const displayName = profile.full_name || user.username || user.email || 'User';
              usernameEl.textContent = displayName;
            }

            // Update avatar circle with first letter of name
            const avatarCircle = document.getElementById('headerAvatarCircle');
            if (avatarCircle) {
              const displayName = profile.full_name || user.username || user.email || 'U';
              avatarCircle.textContent = displayName.charAt(0).toUpperCase();

              // If avatar_url exists, show image instead of letter
              if (profile.avatar_url) {
                const avatarUrl = profile.avatar_url.startsWith('http') || profile.avatar_url.startsWith('/')
                  ? profile.avatar_url
                  : `/static/uploads/avatars/${profile.avatar_url}`;

                // Replace text with image
                avatarCircle.style.backgroundImage = `url('${avatarUrl}')`;
                avatarCircle.style.backgroundSize = 'cover';
                avatarCircle.style.backgroundPosition = 'center';
                avatarCircle.textContent = '';
              }
            }

            console.log('Header refreshed with latest profile data');
          }
        } catch (err) {
          console.warn('Could not refresh user header:', err);
        }
      }

      // auto-load on first paint - wait for DOM to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          console.log('DOM loaded, executing initial search...');
          doSearch();
          // Refresh user header to show latest profile data
          {% if session.get('user') %}
          refreshUserHeader();
          {% endif %}
        });
      } else {
        console.log('DOM already loaded, executing initial search...');
        doSearch();
        // Refresh user header to show latest profile data
        {% if session.get('user') %}
        refreshUserHeader();
        {% endif %}
      }
    </script>
  </body>
</html>
