<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đấu giá - EV Trading</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .auctions-wrap {
        max-width: 1200px;
        margin: 24px auto;
        padding: 0 16px;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 8px 0 12px;
      }
      .create-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        padding: 16px;
        margin-bottom: 16px;
      }
      .form-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .form-row .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 180px;
      }
      .field input,
      .field select {
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
      }
      .btn {
        padding: 10px 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      .btn-primary {
        background: #ff6f00;
        color: #fff;
      }
      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 16px;
      }
      .product-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      .product-image {
        width: 100%;
        height: 160px;
        object-fit: cover;
      }
      .product-info {
        padding: 12px;
      }
      .product-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <div class="logo-section">
          <button class="menu-toggle"><i class="fas fa-bars"></i></button>
          <img src="/static/images/logo.png" alt="EV Trading" class="logo" />
        </div>
        <div class="user-menu">
          <a href="/" class="user-menu-item">Trang chủ</a>
          <a href="/favorites" class="user-menu-item">Yêu thích</a>
          <a href="/cart" class="user-menu-item">Giỏ hàng</a>
          <a href="/admin" class="user-menu-item">Admin</a>
          {% if session.get('user') %}
          <a href="{{ url_for('logout_page') }}" class="user-menu-item"
            >Đăng xuất</a
          >
          {% else %}
          <a href="{{ url_for('login_page') }}" class="user-menu-item"
            >Đăng nhập</a
          >
          {% endif %}
        </div>
      </div>
    </header>

    <div class="auctions-wrap">
      <div class="section-header">
        <h2>Phiên đấu giá đang diễn ra</h2>
      </div>
      <div id="auctionsGrid" class="product-grid"></div>

      <!-- Form tạo phiên đấu giá sẽ được tích hợp từ phần Đăng bài -->
      <!-- Endpoint POST /auctions/create vẫn có sẵn để sử dụng -->
    </div>

    <script>
      const fmtMoney = (v) => (v || 0).toLocaleString("vi-VN") + " đ";
      async function loadAuctions() {
        const grid = document.getElementById("auctionsGrid");
        grid.innerHTML = "";
        let data = [];
        try {
          const r = await fetch("/api/auctions/active");
          if (r.ok) {
            const j = await r.json();
            data = j.data || [];
          }
        } catch (e) {}
        if (data.length === 0) {
          const empty = document.createElement("div");
          empty.style.cssText =
            "padding:16px;color:#777;text-align:center;width:100%";
          empty.textContent = "Chưa có phiên đấu giá nào.";
          grid.appendChild(empty);
          return;
        }
        for (const a of data) {
          let info = null;
          try {
            const url =
              a.item_type === "vehicle"
                ? `/api/listings/vehicles/${a.item_id}`
                : `/api/listings/batteries/${a.item_id}`;
            const r = await fetch(url);
            if (r.ok) info = await r.json();
          } catch (e) {}
          const ends = a ? new Date(a.ends_at) : null;
          const now = new Date();
          const remaining =
            a && ends ? Math.max(0, Math.floor((ends - now) / 1000)) : 0;
          const remStr = a
            ? new Date(remaining * 1000).toISOString().substring(11, 19)
            : "";
          const card = document.createElement("div");
          card.className = "product-card";
          const title =
            a.item_type === "vehicle"
              ? info
                ? `${info.brand || ""} ${info.model || ""} ${info.year || ""}`
                : `Xe #${a.item_id}`
              : info
              ? `${info.brand || ""} ${info.year || ""} - ${
                  info.capacity_kwh || ""
                } kWh`
              : `Pin #${a.item_id}`;
          const img =
            a.item_type === "vehicle"
              ? "/static/images/v1.jpg"
              : "/static/images/v3.jpg";
          const priceText =
            a.highest_bid != null ? a.highest_bid : a.starting_price;
          card.innerHTML = `
            <img src="${img}" alt="auction" class="product-image" style="cursor:pointer" onclick="window.location.href='/auctions/${
            a.id
          }'"/>
            <div class="product-info">
              <h3 class="product-title" style="cursor:pointer" onclick="window.location.href='/auctions/${
                a.id
              }'">${title}</h3>
              <div class="product-price">Giá hiện tại: ${fmtMoney(
                priceText
              )}</div>
              <div class="product-location"><i class="far fa-clock"></i> Còn lại: ${remStr}</div>
              <div class="product-actions">
                <button class="btn" onclick="event.stopPropagation();placeBid(${
                  a.id
                })"><i class='fas fa-gavel'></i> Đấu giá</button>
                ${
                  a.buy_now_price
                    ? `<button class="btn btn-primary" onclick="event.stopPropagation();buyNowAuction(${a.id})"><i class='fas fa-bolt'></i> Mua ngay</button>`
                    : ""
                }
              </div>
            </div>`;
          grid.appendChild(card);
        }
      }
      async function placeBid(aid) {
        const val = prompt("Nhập giá bạn muốn đặt (đ)");
        if (!val) return;
        const amount = parseInt(val.replace(/\D/g, ""), 10) || 0;
        if (amount <= 0) return alert("Giá không hợp lệ");
        const res = await fetch(`/api/auctions/${aid}/bid`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount }),
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          alert("Đã đặt giá thành công!");
          loadAuctions();
        } else if (data && data.error === "low_bid") {
          alert("Giá quá thấp. Tối thiểu: " + fmtMoney(data.min || 0));
        } else if (res.status === 401) {
          alert("Vui lòng đăng nhập để đấu giá.");
          window.location.href = "/login";
        } else {
          alert("Không thể đặt giá lúc này.");
        }
      }
      async function buyNowAuction(aid) {
        if (!confirm("Xác nhận Mua ngay và kết thúc phiên đấu giá?")) return;
        const res = await fetch(`/api/auctions/${aid}/buy-now`, {
          method: "POST",
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          const price = (data && (data.final_price ?? data.buy_now_price)) || 0;
          if (data && data.item_type && data.item_id) {
            const add = await fetch("/cart/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                item_type: data.item_type,
                item_id: data.item_id,
                seller_id: data.seller_id,
                price,
                qty: 1,
              }),
            });
            if (add.ok) {
              alert(
                "Phiên đấu giá đã kết thúc. Sản phẩm đã được đưa vào giỏ hàng."
              );
              window.location.href = "/cart";
              return;
            }
            if (add.status === 401) {
              alert("Vui lòng đăng nhập để hoàn tất Mua ngay.");
              window.location.href = "/login";
              return;
            }
          }
          alert("Phiên đấu giá đã kết thúc.");
          loadAuctions();
        } else if (res.status === 401) {
          alert("Vui lòng đăng nhập để Mua ngay.");
          window.location.href = "/login";
        } else {
          alert("Không thể Mua ngay lúc này.");
        }
      }
      document.addEventListener("DOMContentLoaded", loadAuctions);
    </script>
  </body>
</html>
